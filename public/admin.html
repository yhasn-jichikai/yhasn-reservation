<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YHASN施設予約管理</title>

  <style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  margin: 30px;
	background-color: #f3fbfb;
  min-height: 100vh;
}
   h1 {
  margin-top: 60px;
  color: #0288d1;
  text-align: center;
  font-size: 36px;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 20px;
  background-color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}
th, td {
  border: 1px solid #ddd;
  padding: 12px;
  text-align: center;
  font-size: 14px;
}

#scheduleTable table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  margin-top: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}
#scheduleTable th, #scheduleTable td {
  border: 1px solid #ddd;
  padding: 12px;
  height: 60px;
  text-align: center;
  vertical-align: middle;
  font-size: 14px;
}
   button {
  padding: 6px 12px;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

/* 通常の青ボタン（例：複数選択ボタン） */
button:not(.cancel-btn):not(#cancelSelectedBtn) {
  background-color: #0288d1;
}
button:not(.cancel-btn):not(#cancelSelectedBtn):hover {
  background-color: #0277bd;
}

/* 通常のキャンセルボタン */
button.cancel-btn {
  background-color: #f44336;
}
button.cancel-btn:hover {
  background-color: #d32f2f;
}

/* 一括キャンセルボタン */
#cancelSelectedBtn {
  background-color: #c62828;
  font-weight: bold;
}
#cancelSelectedBtn:hover {
  background-color: #b71c1c;
}
    button:hover {
      background-color: #0277bd;
    }
    #logoutButton {
  margin-top: 10px;
  padding: 10px 20px;
  background-color: #ef5350;
  border-radius: 6px;
  border: none;
  color: white;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.3s, transform 0.2s;
}
#logoutButton:hover {
  background-color: #e53935;
  transform: scale(1.05);
}
    #adminInfo {
      margin-bottom: 10px;
    }
.tab-button {
  padding: 10px 20px;
  margin: 5px 8px;
  border: none;
  background-color: #d0f0ff;
  color: #0277bd;
  font-weight: bold;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.3s, transform 0.2s;
}
.tab-button:hover {
  background-color: #81d4fa;
  transform: scale(1.05);
}
.tab-button.active {
  background-color: #4fc3f7;
  color: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.tab-content {
  margin-top: 20px;
}


#scheduleTable td.empty {
  color: #ccc;
}
    #scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}
    #scheduleTable h3 {
  text-align: left;
  margin-top: 30px;
  font-size: 20px;
  color: #01579b;
  padding-left: 10px;
  border-left: 6px solid #0288d1;
  margin-bottom: 10px;
}
   #scheduleTable th:first-child,
#scheduleTable td:first-child {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
}

#scheduleTable th:not(:first-child) {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
}


#scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}

    #scheduleTable td.empty {
  background-color: #ffffff;
  color: #ccc;
  border: 1px solid #bbb;
}
#scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}

#scheduleTable td:not(.empty) {
  background-color: #fff3e0;
  font-weight: bold;
  color: #e65100;
  border: 1px solid #bbb;
}

#scheduleTable td.time-label {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
  border: 1px solid #bbb;
}
  #hamburgerMenu {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 999;
}

#menuToggle {
  background-color: #00bcd4;  /* 通常時：青緑 */
  color: white;
  border: none;
  padding: 10px 14px;
  font-size: 24px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}

#menuToggle:hover {
  background-color: #0097a7;  /* ホバー時：濃いめの青緑 */
}

#sideMenu {
  position: fixed;
  top: 0;
  left: -280px;
  width: 240px;
  height: 100%;
  background-color: #e1f5fe;
  padding: 20px;
  box-shadow: 2px 0 6px rgba(0,0,0,0.2);
  transition: left 0.3s ease;
  z-index: 1500;
}

#sideMenu.visible {
  left: 0;
}

#sideMenu .menu-header {
  font-weight: bold;
  font-size: 18px;
  color: #006064;
  margin-bottom: 20px;
}

#sideMenu .menu-user {
  font-size: 14px;
  color: #333;
  margin-bottom: 20px;
}

#sideMenu button {
  display: block;
  width: 100%;
  margin: 10px 0;
  padding: 10px;
  background-color: #0288d1;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: left;
}

/* ハンバーガーメニュー内のログアウトボタンを強調 */
#sideMenu #logoutButtonSide {
  background-color: #f44336; /* 赤色 */
  margin-top: 20px;          /* 上にスペースを追加 */
  text-align: center;        /* 文字を中央寄せ */
}

#sideMenu #logoutButtonSide:hover {
  background-color: #d32f2f; /* ホバー時の濃い赤 */
}


#sideMenu button:hover {
  background-color: #0277bd;
}  

#menuOverlay {
  position: fixed;
  top: 0;
  left: 280px;
  width: calc(100vw - 280px);
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.3);
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#menuOverlay.visible {
  opacity: 1;
  pointer-events: auto;
}

#menuOverlay.hidden {
  opacity: 0;
  pointer-events: none;
}

#profileImage {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
    
/* === 予約表：複数選択用チェックボックスのUI改善 === */
#reservationsTable.multi-mode td:nth-child(8) {
  /* 「操作」列（8列目）をホバーで分かりやすく */
  cursor: pointer;
}
#reservationsTable.multi-mode td:nth-child(8):hover {
  background: #e3f2fd;
}

/* 行ホバーでうっすら可視化（視線誘導用） */
#reservationsTable tbody tr:hover {
  background: #f7fbff;
}

/* チェックボックス自体を大きく・押しやすく */
.multi-cancel-checkbox {
  width: 24px;
  height: 24px;
  /* 対応ブラウザなら色も統一 */
  accent-color: #0288d1;
  cursor: pointer;
  vertical-align: middle;
}
.multi-cancel-checkbox:hover {
  outline: 2px solid #81d4fa;
  outline-offset: 2px;
  border-radius: 4px;
}

            
/* === PC向け：空室表の最大幅を制限して中央寄せ === */
@media (min-width: 1024px) {
  /* 好みで調整：1100〜1300pxくらいが見やすい */
  :root { --schedule-max-width: 1200px; }

  /* 空室表コンテナをセンター＆最大幅制限 */
  #scheduleTable {
    max-width: var(--schedule-max-width);
    margin-left: auto;
    margin-right: auto;
  }

  /* PCでは少しだけ詰めて表示（文字とパディングを控えめに） */
  #scheduleTable th,
  #scheduleTable td {
    font-size: 13px;
    padding: 8px;
  }

  /* 時間帯の列が潰れすぎないよう幅を確保（必要に応じて調整） */
  #scheduleTable td.time-label {
    width: 140px;
    white-space: nowrap;
  }
}

/* 横スクロール許可（必要なときだけ使う） */
#scheduleTable { overflow-x: auto; }
#scheduleTable table { min-width: 1100px; } /* 横幅の下限（好みで調整） */


/* === モバイルのタップ体感を改善（即時フィードバック） === */
#scheduleTable td.empty {
  transition: background-color 40ms linear, transform 40ms ease;
  -webkit-tap-highlight-color: transparent; /* モバイルの青ハイライトを消す */
  touch-action: manipulation;               /* ダブルタップ待ち等を抑制 */
}
#scheduleTable td.empty.tap-active {
  background-color: #e0f7fa !important;     /* うっすら色変化：押した感 */
  transform: scale(0.995);                   /* ほんの少しだけ縮ませる */
}

/* ボタン類にもヒント（必要なら） */
button, .tab-button { touch-action: manipulation; }

    
  </style>
  
  <!-- flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

</head>
<body>





<div id="hamburgerMenu">
  <button id="menuToggle">&#9776;</button> <!-- 三本線マーク -->

  <div id="sideMenu">
    <div class="menu-header">YHASN施設予約管理</div>
    <div class="menu-user">
      <img id="profileImage" src="" alt="プロフィール画像" style="display:none;">
      <div id="menuUserEmail">ログイン中</div>
    </div>


    
    <hr>
    <button onclick="location.href='admin-reserve.html'">教員用予約ページへ</button>
<button onclick="window.open('admin-suspend.html', '_blank')">停止アカウント管理</button>
<button onclick="window.open('admin-board.html', '_self')">掲示板（お知らせ投稿）</button>
<button id="logoutButtonSide">ログアウト</button>


  </div>
</div>
    <div id="menuOverlay" class="hidden"></div>


<h1>YHASN施設予約管理</h1>







<!-- タブ切り替えボタン -->
<div style="margin-bottom: 20px;">
  <button class="tab-button active" onclick="switchTab('reservationsTab')">予約情報一覧</button>
  <button class="tab-button" onclick="switchTab('emptyTab')">空室表</button>
</div>

<!-- 複数選択・一括キャンセルボタン -->
<div style="text-align: right; margin-bottom: 10px;">
  <button onclick="cancelSelected()" id="cancelSelectedBtn" class="cancel-btn" style="display:none;">選択した項目を一括キャンセル</button>
  <button onclick="toggleMultiSelectMode()" id="multiSelectBtn">複数選択</button>
</div>



<!-- ▼ これを追加：予約情報一覧タブ -->
<div id="reservationsTab" class="tab-content">

<!-- ▼ 昇順・降順の切り替えボタン -->
<div style="text-align: right; margin-bottom: 10px;">
  <button onclick="changeSortOrder('asc')">昇順</button>
  <button onclick="changeSortOrder('desc')">降順</button>
</div>

<table id="reservationsTable">
    <thead>
      <tr>
        <th>日付</th>
        <th>時間</th>
        <th>部屋</th>
        <th>名前</th>
        <th>学籍番号</th>
        <th>学年</th>
        <th>メール</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<!-- ▼ ページャ -->
<div id="pager" style="display:flex; gap:10px; align-items:center; justify-content:center; margin-top:8px;">
  <button id="prevPageBtn" style="display:none;">＜ 前30件</button>
  <span id="pageInfo" style="font-weight:bold;"></span>
  <button id="nextPageBtn" style="display:none;">次30件 ＞</button>
</div>



</div>

<div id="emptyTab" class="tab-content" style="display:none;">
  <div style="text-align: center; margin-bottom: 10px;">
    <button id="prevDayBtn">＜ 前の日</button>
    <input type="text" id="datePicker" readonly style="width: 150px; text-align:center;">
    <button id="nextDayBtn">次の日 ＞</button>
  </div>
  <div id="scheduleTable"></div>
</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
  

    
    // Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyCw6RzSw72t0BKoGjCONNPwz4plqn-74VY",
      authDomain: "yhasn-reserve.firebaseapp.com",
      projectId: "yhasn-reserve",
      storageBucket: "yhasn-reserve.appspot.com",
      messagingSenderId: "406712332925",
      appId: "1:406712332925:web:fb9253a313e4c76cfcb714"
    };
    // Firebase初期化
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// ==== ここから追記（db の直後） ====
// index.html と同じ Web アプリ URL とシークレットを使う
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwBztqWNBpozNAL9S10_K44z4T5l8vIv7a7s3SyjI1W7zZhvdhLfaZVeLNVSBvcxIQ06A/exec';
const SHARED_SECRET = 'yhasn_2025jichikai_reservation_sending-email';

// 管理者キャンセル通知メール（予約者へ）
async function sendMailAdminCancel({ to, dateText, timeText, roomText, studentId, studentName, grade }) {
  const subject = `【管理者処理】予約をキャンセルしました：${dateText} ${timeText} ${roomText}`;
  const html = `
    <div style="font-family:'Noto Sans JP',sans-serif; line-height:1.7;">
      <p>${studentName || '利用者'} さん</p>
      <p>以下の予約は<strong>管理者によりキャンセル</strong>されました。</p>
      <table style="border-collapse:collapse;">
        <tr><td style="padding:4px 8px;">日付</td><td style="padding:4px 8px;">${dateText}</td></tr>
        <tr><td style="padding:4px 8px;">時間</td><td style="padding:4px 8px;">${timeText}</td></tr>
        <tr><td style="padding:4px 8px;">ベッド/部屋</td><td style="padding:4px 8px;">${roomText}</td></tr>
        <tr><td style="padding:4px 8px;">学籍番号</td><td style="padding:4px 8px;">${studentId || '-'}</td></tr>
        <tr><td style="padding:4px 8px;">氏名</td><td style="padding:4px 8px;">${studentName || '-'}</td></tr>
        <tr><td style="padding:4px 8px;">学年</td><td style="padding:4px 8px;">${grade || '-'}</td></tr>
      </table>
      <p>※このメールは送信専用です。</p>
    </div>
  `;
  try {
    // プリフライト回避のため text/plain を利用（index と同じ方式）
    await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        secret: SHARED_SECRET,
        to,
        subject,
        html,
        origin: location.origin
      })
    }).catch(e => console.warn('メール送信失敗(ネットワーク)', e));
  } catch (e) {
    console.warn('メール送信失敗', e);
  }
}
// ==== ここまで追記 ====

// 0埋めされたベッド名（ベッド01など）をベッド1形式で表示する
function formatRoomName(room) {
  if (room.startsWith("ベッド")) {
    const num = room.replace("ベッド", "").replace(/^0+/, ""); // 先頭の0を削除
    return "ベッド" + num;
  }
  return room;
}

// ▼ 並べ替え制御用
let currentSortOrder = "asc";  // 初期は昇順

function changeSortOrder(order) {
  currentSortOrder = order;
  currentPage = 0; // ← 並び替え時は1ページ目へ

  loadReservations(); // 並べ替え再実行
}


// ▼ 追記：複数選択モード制御用
let multiSelectMode = false;
let selectedIds = [];

// ▼ ページング制御
const PAGE_SIZE = 30;
let currentPage = 0;
let allDocs = []; // {id, data} の配列（本日以降の全予約）を保持



firebase.auth().onAuthStateChanged(user => {
  const redirectedFromLogout = sessionStorage.getItem("justLoggedOut");

  if (!user) {
    if (!redirectedFromLogout) {
      alert("ログインしてください");
    }
    window.location.href = "admin-login.html";
  } else {
    sessionStorage.removeItem("justLoggedOut"); // ログイン状態なら不要

    loadReservations();
    setupFlatpickrAndButtons();
  }
});

function loadReservations() {
  console.log("✅ loadReservations 実行されたよ！");

  const tbody = document.querySelector("#reservationsTable tbody");
  tbody.innerHTML = "";

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;

  db.collection("reservations")
  .where("date", ">=", todayStr)
	.orderBy("date", currentSortOrder)
	.orderBy("time", currentSortOrder)
	.orderBy("room", "asc")
	.orderBy("studentId", "asc")
	.orderBy("name", "asc")
	.orderBy("grade", "asc")
	.orderBy("email", "asc")
    .get()
    .then(snapshot => {


      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='8'>本日以降の予約はありません</td></tr>";
        return;
      }

            // 取得データを配列に保持（並び順はクエリで確定済み）
      allDocs = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

      // 初回はページ先頭に戻す
      currentPage = 0;

      // 1ページを描画
      renderPage();



    })
    .catch(err => {
      console.error("読み込みエラー:", err);
      tbody.innerHTML = "<tr><td colspan='8'>読み込みに失敗しました</td></tr>";
      document.body.innerHTML += `<p style="color:red;">読み込みエラー: ${err.message}</p>`;
    });
}

// ===== ページ描画＆ページャ制御 =====
function renderPage() {
  const tbody = document.querySelector("#reservationsTable tbody");
  tbody.innerHTML = "";

  if (!Array.isArray(allDocs) || allDocs.length === 0) {
    tbody.innerHTML = "<tr><td colspan='8'>本日以降の予約はありません</td></tr>";
    // ページャ非表示
    updatePager(0, 0, 0);
    // multi-mode視覚状態の初期化
    document.getElementById("reservationsTable").classList.remove("multi-mode");
    document.getElementById("cancelSelectedBtn").style.display = "none";
    return;
  }

  const start = currentPage * PAGE_SIZE;
  const end = Math.min(start + PAGE_SIZE, allDocs.length);
  const pageItems = allDocs.slice(start, end);

  // 行DOM生成
  for (const { id, data } of pageItems) {
    const tr = document.createElement("tr");
    // 既に選択済みを復元
    const checkedAttr = selectedIds.includes(id) ? "checked" : "";

    tr.innerHTML = `
      <td>${data.date}</td>
      <td>${data.time}</td>
      <td>${formatRoomName(data.room)}</td>
      <td>${data.name}</td>
      <td>${data.studentId || ""}</td>
      <td>${data.grade || ""}</td>
      <td>${data.email}</td>
      <td>
        ${
          multiSelectMode
            ? `<input type="checkbox" class="multi-cancel-checkbox" data-id="${id}" onchange="toggleSelect('${id}', this.checked)" ${checkedAttr}>`
            : `<button class="cancel-btn" data-id="${id}" onclick="cancelSingle('${id}')">キャンセル</button>`
        }
      </td>
    `;
    tbody.appendChild(tr);
  }

  // 複数選択モードのUI同期（ホバー・ボタン表示）
  const tableEl = document.getElementById("reservationsTable");
  if (multiSelectMode) {
    tableEl.classList.add("multi-mode");
    document.getElementById("cancelSelectedBtn").style.display = "inline-block";
  } else {
    tableEl.classList.remove("multi-mode");
    document.getElementById("cancelSelectedBtn").style.display = "none";
  }

  // ドラッグ選択のイベントを最新の要素に張り直し
  if (typeof wireUpCheckboxUX === "function") {
    wireUpCheckboxUX();
  }

  // ページャ更新
  updatePager(start + 1, end, allDocs.length);
}

function updatePager(from, to, total) {
  const prevBtn = document.getElementById("prevPageBtn");
  const nextBtn = document.getElementById("nextPageBtn");
  const info    = document.getElementById("pageInfo");

  // 総件数0なら非表示
  if (total === 0) {
    if (prevBtn) prevBtn.style.display = "none";
    if (nextBtn) nextBtn.style.display = "none";
    if (info)    info.textContent = "";
    return;
  }

  // 表示テキスト「1–30 / 120件」
  if (info) {
    info.textContent = `${from}–${to} / ${total}件`;
  }

  // 前・次の可視/不可視
  if (prevBtn) prevBtn.style.display = currentPage > 0 ? "inline-block" : "none";
  if (nextBtn) nextBtn.style.display = (currentPage + 1) * PAGE_SIZE < total ? "inline-block" : "none";
}

// ページャのボタンイベント（重複バインド防止）
(function setupPagerOnce() {
  const prevBtn = document.getElementById("prevPageBtn");
  const nextBtn = document.getElementById("nextPageBtn");
  if (!prevBtn || !nextBtn) return;

  if (!prevBtn._bound) {
    prevBtn.addEventListener("click", () => {
      if (currentPage > 0) {
        currentPage--;
        renderPage();
      }
    });
    prevBtn._bound = true;
  }

  if (!nextBtn._bound) {
    nextBtn.addEventListener("click", () => {
      if ((currentPage + 1) * PAGE_SIZE < allDocs.length) {
        currentPage++;
        renderPage();
      }
    });
    nextBtn._bound = true;
  }
})();


   
    
function switchTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(div => div.style.display = "none");
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));

  document.getElementById(tabId).style.display = "block";
  
    // ▼ 追加：複数選択ボタンの表示切り替え
  const multiBtn = document.getElementById("multiSelectBtn");
  const cancelBtn = document.getElementById("cancelSelectedBtn");
  if (multiBtn && cancelBtn) {
    if (tabId === "reservationsTab") {
      multiBtn.style.display = "inline-block";
      if (multiSelectMode) {
        cancelBtn.style.display = "inline-block";
      }
    } else {
      multiBtn.style.display = "none";
      cancelBtn.style.display = "none";
    }
  }
    // ← 追記：タブ切替時も複数選択ボタンのラベルを現在モードに同期
  if (multiBtn) {
    multiBtn.textContent = multiSelectMode ? "複数選択解除" : "複数選択";
  }


  // 呼び出し元イベントが使えないので、class追加は tabId に応じて明示的に書く
  if (tabId === "reservationsTab") {
    document.querySelector("button[onclick*='reservationsTab']").classList.add("active");
  } else if (tabId === "emptyTab") {
    document.querySelector("button[onclick*='emptyTab']").classList.add("active");
  }

  if (tabId === "emptyTab") {
    const fp = document.getElementById("datePicker")._flatpickr;
    const selected = fp.selectedDates[0] || fp.latestSelectedDateObj || fp.parseDate(fp.input.value);
    if (selected) {
      currentDate = selected;
      loadSchedule(currentDate);
      updatePrevButtonVisibility(currentDate);
    }
  }
}

// 祝日リスト
const allHolidays = {
  "2025-01-01": "元日",
  "2025-01-13": "成人の日",
  "2025-02-11": "建国記念の日",
  "2025-02-23": "天皇誕生日",
  "2025-03-20": "春分の日",
  "2025-04-29": "昭和の日",
  "2025-05-03": "憲法記念日",
  "2025-05-04": "みどりの日",
  "2025-05-05": "こどもの日",
  "2025-05-06": "振替休日",
  "2025-07-21": "海の日",
  "2025-08-11": "山の日",
  "2025-09-15": "敬老の日",
  "2025-09-23": "秋分の日",
  "2025-10-13": "スポーツの日",
  "2025-11-03": "文化の日",
  "2025-11-23": "勤労感謝の日",
  "2025-12-23": "天皇誕生日"
};

// ✅ 初期日付の決定：今日が土日祝なら直近の平日にシフト
function findInitialAdminDate(startDate) {
  let d = new Date(startDate);
  while (
    d.getDay() === 0 || d.getDay() === 6 || 
    allHolidays[formatDate(d)]
  ) {
    d.setDate(d.getDate() + 1);
  }
  return d;
}

let currentDate = findInitialAdminDate(new Date()); // ← 修正版


function getNextValidDate(date, step = 0) {
  const next = new Date(date);
  next.setDate(next.getDate() + step);
  while (next.getDay() === 0 || next.getDay() === 6 || allHolidays[formatDate(next)]) {
    next.setDate(next.getDate() + (step >= 0 ? 1 : -1));
  }
  return next;
}

function formatDate(date) {
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function loadSchedule(date) {
  const scheduleTable = document.getElementById("scheduleTable");
  scheduleTable.innerHTML = "";

  const dateStr = formatDate(date);
  const timeSlots = ["08:30-09:00", "09:00-10:40（１限）", "10:40-12:10（２限）", "12:10-13:20（昼休み）", "13:20-15:00（３限）", "15:00-16:30（４限）", "16:30-18:00", "18:00-20:00"];
    // Firestore 保存名に合わせた 0埋め版の部屋リスト
  // 表示時は formatRoomName(room) で「ベッド1〜12」に整形して見せる
  const allRooms = [
    "学生演習室1", "学生演習室2", "学生演習室3", "学生演習室4", "学生演習室5",
    "交流室",
    "ベッド01", "ベッド02", "ベッド03", "ベッド04", "ベッド05", "ベッド06",
    "ベッド07", "ベッド08", "ベッド09", "ベッド10", "ベッド11", "ベッド12"
  ];

  function generateTable(rooms, title) {
    // ヘッダは保存名→表示名に変換して出す（例：ベッド01 → ベッド1）
   

    timeSlots.forEach(time => {
      html += `<tr><td class="time-label">${time}</td>`;
      rooms.forEach(room => {
        // ここでの room は保存名（ベッド01 等）。Firestore の data.room と一致する。
        const key = `${time}_${room}`;
        const d = dataMap[key];
        if (d) {
          html += `<td>
  <div style="font-size: 12px; font-weight: bold;">${d.studentId || ""}</div>
  <div style="font-size: 13px;">${d.grade || ""}</div>
  <div style="font-size: 14px; font-weight: 600; color: #0277bd;">${d.name || ""}</div>
</td>`;
        } else {
          html += `<td class="empty" title="予約可能"><i class="fas fa-circle"></i></td>`;
        }
      });
      html += `</tr>`;
    });

    html += `</tbody></table><br>`;
    return html;
  }


  db.collection("reservations")
    .where("date", "==", dateStr)
    .get()
    .then(snapshot => {
      const dataMap = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        dataMap[`${data.time}_${data.room}`] = data;
      });

      function generateTable(rooms, title) {
        let html = `<h3>${title}</h3><table><thead><tr><th>時間帯</th>`;
        rooms.forEach(room => html += `<th>${room}</th>`);
        html += `</tr></thead><tbody>`;

        timeSlots.forEach(time => {
          html += `<tr><td class="time-label">${time}</td>`;
          rooms.forEach(room => {
            const key = `${time}_${room}`;
            const d = dataMap[key];
            if (d) {
             html += `<td>
  <div style="font-size: 12px; font-weight: bold;">${d.studentId || ""}</div>
  <div style="font-size: 13px;">${d.grade || ""}</div>
  <div style="font-size: 14px; font-weight: 600; color: #0277bd;">${d.name || ""}</div>
</td>`;
            } else {
           html += `<td class="empty" title="予約可能"><i class="fas fa-circle"></i></td>`;
            }
          });
          html += `</tr>`;
        });

        html += `</tbody></table><br>`;
        return html;
      }

      const group1 = allRooms.filter(r => r.includes("演習室") || r.includes("交流室"));
      const group2 = allRooms.filter(r => r.includes("ベッド"));

      scheduleTable.innerHTML =
        generateTable(group1, "学生演習室・交流室") +
        generateTable(group2, "ベッド（1〜12）");
              // === 追記：空室セルのタップ即時フィードバック（モバイル体感向上） ===
      (function bindFastTapOnce() {
        const root = document.getElementById("scheduleTable");
        if (!root || root._fastTapBound) return;

        // 押した瞬間に見た目だけ先に変える
        root.addEventListener("pointerdown", (e) => {
          const td = e.target.closest("td.empty");
          if (!td) return;
          td.classList.add("tap-active");
        }, { passive: true });

        // 離したら少しだけ余韻を残して元に戻す
        const clearActive = (e) => {
          const td = (e && e.target && e.target.closest) ? e.target.closest("td.empty") : null;
          if (td) setTimeout(() => td.classList.remove("tap-active"), 80);
        };
        root.addEventListener("pointerup", clearActive,   { passive: true });
        root.addEventListener("pointercancel", clearActive, { passive: true });
        root.addEventListener("pointerleave", clearActive,  { passive: true });

        root._fastTapBound = true;
      })();

    })
    .catch(err => {
      scheduleTable.innerHTML = `<p style="color:red;">読み込み失敗: ${err.message}</p>`;
    });
}

function setupFlatpickrAndButtons() {
  flatpickr("#datePicker", {
  locale: "ja",
  dateFormat: "Y-m-d",
  defaultDate: currentDate,
minDate: new Date(), // ← 土日祝に関係なく「今日」から選択可能
  disable: [
    function(date) {
      const day = date.getDay();
      const dateStr = formatDate(date);
      return day === 0 || day === 6 || allHolidays[dateStr];
    }
  ],
onChange: ([selectedDate]) => {
  if (selectedDate) {
    currentDate = selectedDate;
    loadSchedule(currentDate);
    updatePrevButtonVisibility(currentDate);
  }
},
 onReady: ([selectedDate]) => {
  currentDate = selectedDate || currentDate;
  loadSchedule(currentDate);
  updatePrevButtonVisibility(currentDate);
}
    
});
setTimeout(() => {
  const fp = document.getElementById("datePicker")._flatpickr;
  fp.setDate(currentDate, true);
fp.input.value = formatDate(currentDate); // ← これ追加！
}, 0);
document.getElementById("prevDayBtn").addEventListener("click", () => {
  const fp = document.getElementById("datePicker")._flatpickr;
  const newDate = getNextValidDate(currentDate, -1);
currentDate = newDate;
fp.setDate(newDate, true);
fp.input.value = formatDate(newDate); // ← これ追加！
loadSchedule(newDate);
updatePrevButtonVisibility(currentDate);
});

document.getElementById("nextDayBtn").addEventListener("click", () => {
  const fp = document.getElementById("datePicker")._flatpickr;
const newDate = getNextValidDate(currentDate, 1);
currentDate = newDate;
fp.setDate(newDate, true);
fp.input.value = formatDate(newDate); // ← これ追加！
loadSchedule(newDate);
updatePrevButtonVisibility(currentDate);
});


 
  function updatePrevButtonVisibility(selectedDate) {
  const today = new Date();
  today.setHours(0, 0, 0, 0); // 時間部分を無視するためクリア
  const selected = new Date(selectedDate);
  selected.setHours(0, 0, 0, 0);
  
  const isBeforeOrSame = selected <= today;
  document.getElementById("prevDayBtn").style.display = isBeforeOrSame ? "none" : "inline-block";
}
}
   // ▼ 一括キャンセル処理（メール送信対応版）
document.getElementById("cancelSelectedBtn").addEventListener("click", async () => {
  const checked = document.querySelectorAll(".multi-cancel-checkbox:checked");
  if (checked.length === 0) {
    alert("キャンセルする予約を選択してください。");
    return;
  }

  if (!confirm(`${checked.length}件の予約を一括キャンセルしますか？\n（各予約者にキャンセルメールが送信されます）`)) return;

  let successCount = 0;
  let errorCount = 0;

  for (const cb of checked) {
    const id = cb.dataset.id;
    try {
      const snap = await db.collection("reservations").doc(id).get();
      if (!snap.exists) { errorCount++; continue; }
      const d = snap.data();

      await sendMailAdminCancel({
        to: d.email,
        dateText: d.date,
        timeText: d.time,
        roomText: formatRoomName(d.room),
        studentId: d.studentId || '',
        studentName: d.name || '',
        grade: d.grade || ''
      });

      await db.collection("reservations").doc(id).delete();
      successCount++;
    } catch (e) {
      console.error(e);
      errorCount++;
    }
  }

  alert(`キャンセル完了：${successCount}件、失敗：${errorCount}件`);
  currentPage = 0;
  loadReservations();
});

function toggleSelect(id, checked) {
  if (checked) {
    selectedIds.push(id);
  } else {
    selectedIds = selectedIds.filter(i => i !== id);
  }
}

function toggleMultiSelectMode() {
  multiSelectMode = !multiSelectMode;

  // ボタン表示／ラベル更新
  const multiBtn = document.getElementById("multiSelectBtn");
  const cancelBtn = document.getElementById("cancelSelectedBtn");

  if (multiBtn) {
    multiBtn.textContent = multiSelectMode ? "複数選択解除" : "複数選択";
    multiBtn.setAttribute("aria-pressed", String(multiSelectMode));
  }
  if (cancelBtn) {
    cancelBtn.style.display = multiSelectMode ? "inline-block" : "none";
  }

  // 表の再描画（チェックボックス化/解除）
  loadReservations();
}


// === ここからドラッグ選択の実装 ===
// チェック状態を安全に反映（selectedIdsも同期）
function setCheckboxState(cb, state) {
  if (!cb) return;
  const id = cb.dataset.id;
  if (typeof state === "boolean") {
    cb.checked = state;
    // 既存の toggleSelect を流用して選択配列を同期
    toggleSelect(id, state);
  }
}

// ドラッグ中フラグと、ドラッグで付けるべき状態（true=チェック、false=外す）
let dragSelecting = false;
let dragValue = false;

// 今表示中のチェックボックスにイベントを張る
function wireUpCheckboxUX() {
  const boxes = document.querySelectorAll(".multi-cancel-checkbox");
  boxes.forEach(cb => {
    // マウスダウン開始：ここでドラッグ選択の基準状態を決める
    cb.addEventListener("mousedown", (e) => {
      if (!multiSelectMode) return;         // 複数選択モードのときだけ
      e.preventDefault();                   // ブラウザの既定のトグルを止める
      dragSelecting = true;
      dragValue = !cb.checked;              // いまの反対を「今回のドラッグ値」にする
      setCheckboxState(cb, dragValue);      // まず自分に反映
    });

    // マウスオーバー中：ドラッグ中なら同じ状態をどんどん反映
    cb.addEventListener("mouseover", () => {
      if (dragSelecting && multiSelectMode) {
        setCheckboxState(cb, dragValue);
      }
    });
  });
}

// マウスアップでドラッグ終了（どこで離してもOK）
document.addEventListener("mouseup", () => {
  dragSelecting = false;
});

// 「操作」セル全体をクリックでトグル（ホットエリア拡張）
// クリック1発でチェック/解除できるようにする（複数選択モード時のみ）
const reservationsTable = document.getElementById("reservationsTable");
if (reservationsTable && !reservationsTable._cellClickBound) {
  reservationsTable.addEventListener("click", (e) => {
    if (!multiSelectMode) return;

    const td = e.target.closest("td");
    if (!td) return;

    // 0始まりで8列目（=操作列）は index 7
    if (td.cellIndex !== 7) return;

    const cb = td.querySelector(".multi-cancel-checkbox");
    if (cb) {
      const newState = !cb.checked;
      setCheckboxState(cb, newState);
    }
  });
  // 二重バインド防止フラグ
  reservationsTable._cellClickBound = true;
}


// 管理者から単体キャンセル（メール送信→削除）
async function cancelSingle(id) {
  try {
    const snap = await db.collection("reservations").doc(id).get();
    if (!snap.exists) {
      alert("予約データが見つかりません。");
      return;
    }
    const d = snap.data();
    const roomText = formatRoomName(d.room); // ベッド01 → ベッド1 に整形

    const msg =
      `以下の予約をキャンセルします。\n\n` +
      `日付：${d.date}\n` +
      `時間：${d.time}\n` +
      `部屋：${roomText}\n` +
      `氏名：${d.name || ''}\n` +
      `学籍番号：${d.studentId || ''}\n` +
      `学年：${d.grade || ''}\n` +
      `メール：${d.email || ''}`;

    if (!confirm(msg)) return;

    // 先にメール送信（失敗してもキャンセル自体は進める設計）
    await sendMailAdminCancel({
      to: d.email,
      dateText: d.date,
      timeText: d.time,
      roomText,
      studentId: d.studentId || '',
      studentName: d.name || '',
      grade: d.grade || ''
    });

    await db.collection("reservations").doc(id).delete();
    alert("キャンセルしました（予約者へ通知メール送信）");
    currentPage = 0;
    loadReservations();
  } catch (e) {
    console.error(e);
    alert("キャンセル処理でエラーが発生しました。");
  }
}


// ハンバーガーメニューの表示切り替え
document.getElementById("menuToggle").addEventListener("click", () => {
  const sideMenu = document.getElementById("sideMenu");
  const overlay = document.getElementById("menuOverlay");
  const isVisible = sideMenu.classList.toggle("visible");




  if (isVisible) {
  overlay.classList.remove("hidden");
  overlay.classList.add("visible");
} else {
  overlay.classList.remove("visible");
  overlay.classList.add("hidden");
}
});

document.getElementById("menuOverlay").addEventListener("click", () => {
  document.getElementById("sideMenu").classList.remove("visible");
  document.getElementById("menuOverlay").classList.remove("visible");
  document.getElementById("menuOverlay").classList.add("hidden");
});

// メニュー内ログアウトボタン処理
document.getElementById("logoutButtonSide").addEventListener("click", () => {
  sessionStorage.setItem("justLoggedOut", "1");
  firebase.auth().signOut().then(() => {
    alert("ログアウトしました。画面遷移します");
    location.href = "admin-login.html";
  });
});

// Firebaseログイン後にメールアドレス表示
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    const emailDiv = document.getElementById("menuUserEmail");
        if (emailDiv) {
      const name = user.displayName || "";
      const nameParts = name.trim().split(" ");
      const reversedName = nameParts.length === 2 ? `${nameParts[0]} ${nameParts[1]}` : name;
      emailDiv.textContent = `${reversedName}（${user.email}）でログイン中`;
    }
    if (user.photoURL) {
  const profileImg = document.getElementById("profileImage");
  profileImg.src = user.photoURL;
  profileImg.style.display = "block";
}
  }
});

  </script>
</body>
</html>




