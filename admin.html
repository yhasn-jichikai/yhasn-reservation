<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YHASNæ–½è¨­äºˆç´„ç®¡ç†</title>
  <!-- ç®¡ç†è€…ç”¨äºˆç´„å…¥åŠ›ç”»é¢ã¸ã®é·ç§»ãƒœã‚¿ãƒ³ -->
<div style="text-align: right; margin-bottom: 20px;">
  <button onclick="location.href='admin-reserve.html'" style="background-color: #00796b; color: white; padding: 10px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">
    ç®¡ç†è€…ç”¨äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã¸
  </button>
</div>
  <style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  margin: 30px;
  background: linear-gradient(to bottom, #e0f7fa, #80deea);
  min-height: 100vh;
}
   h1 {
  color: #0277bd;
  text-align: center;
  font-size: 28px;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 20px;
  background-color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}
th, td {
  border: 1px solid #ddd;
  padding: 12px;
  text-align: center;
  font-size: 14px;
}

#scheduleTable table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  margin-top: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}
#scheduleTable th, #scheduleTable td {
  border: 1px solid #ddd;
  padding: 12px;
  height: 60px;
  text-align: center;
  vertical-align: middle;
  font-size: 14px;
}
   button {
  padding: 6px 12px;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

/* é€šå¸¸ã®é’ãƒœã‚¿ãƒ³ï¼ˆä¾‹ï¼šè¤‡æ•°é¸æŠãƒœã‚¿ãƒ³ï¼‰ */
button:not(.cancel-btn):not(#cancelSelectedBtn) {
  background-color: #0288d1;
}
button:not(.cancel-btn):not(#cancelSelectedBtn):hover {
  background-color: #0277bd;
}

/* é€šå¸¸ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ */
button.cancel-btn {
  background-color: #f44336;
}
button.cancel-btn:hover {
  background-color: #d32f2f;
}

/* ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ */
#cancelSelectedBtn {
  background-color: #c62828;
  font-weight: bold;
}
#cancelSelectedBtn:hover {
  background-color: #b71c1c;
}
    button:hover {
      background-color: #0277bd;
    }
    #logoutButton {
  margin-top: 10px;
  padding: 10px 20px;
  background-color: #ef5350;
  border-radius: 6px;
  border: none;
  color: white;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.3s, transform 0.2s;
}
#logoutButton:hover {
  background-color: #e53935;
  transform: scale(1.05);
}
    #adminInfo {
      margin-bottom: 10px;
    }
.tab-button {
  padding: 10px 20px;
  margin: 5px 8px;
  border: none;
  background-color: #b3e5fc;
  color: #0277bd;
  font-weight: bold;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.3s, transform 0.2s;
}
.tab-button:hover {
  background-color: #81d4fa;
  transform: scale(1.05);
}
.tab-button.active {
  background-color: #0288d1;
  color: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.tab-content {
  margin-top: 20px;
}


#scheduleTable td.empty {
  color: #ccc;
}
    #scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}
    #scheduleTable h3 {
  text-align: left;
  margin-top: 30px;
  font-size: 20px;
  color: #01579b;
  padding-left: 10px;
  border-left: 6px solid #0288d1;
  margin-bottom: 10px;
}
   #scheduleTable th:first-child,
#scheduleTable td:first-child {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
}

#scheduleTable th:not(:first-child) {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
}


#scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}

    #scheduleTable td.empty {
  background-color: #ffffff;
  color: #ccc;
  border: 1px solid #bbb;
}
#scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}

#scheduleTable td:not(.empty) {
  background-color: #fff3e0;
  font-weight: bold;
  color: #e65100;
  border: 1px solid #bbb;
}

#scheduleTable td.time-label {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
  border: 1px solid #bbb;
}
  #hamburgerMenu {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 999;
}

#menuToggle {
  background-color: #0288d1;
  color: white;
  border: none;
  padding: 10px 14px;
  font-size: 18px;
  border-radius: 4px;
  cursor: pointer;
}

#sideMenu {
  position: fixed;
  top: 0;
  left: -250px;
  width: 240px;
  height: 100%;
  background-color: #e0f7fa;
  padding: 20px;
  box-shadow: 2px 0 6px rgba(0,0,0,0.2);
  transition: left 0.3s ease;
  z-index: 1000;
}

#sideMenu.visible {
  left: 0;
}

#sideMenu .menu-header {
  font-weight: bold;
  font-size: 18px;
  color: #006064;
  margin-bottom: 20px;
}

#sideMenu .menu-user {
  font-size: 14px;
  color: #333;
  margin-bottom: 20px;
}

#sideMenu button {
  display: block;
  width: 100%;
  margin: 10px 0;
  padding: 10px;
  background-color: #0288d1;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: left;
}

#sideMenu button:hover {
  background-color: #0277bd;
}  
    
    
  </style>
  
  <!-- flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

</head>
<body>

<!-- â–¼ ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœ¬ä½“ -->
<div id="hamburgerMenu">
  <button id="menuToggle">&#9776;</button> <!-- ä¸‰æœ¬ç·šãƒãƒ¼ã‚¯ -->

  <div id="sideMenu" class="hidden">
    <div class="menu-header">YHASNæ–½è¨­äºˆç´„ç®¡ç†</div>
    <div class="menu-user">
      <div id="menuUserEmail">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div>
    </div>
    <hr>
    <button onclick="location.href='admin-reserve.html'">æ•™å“¡ç”¨äºˆç´„ãƒšãƒ¼ã‚¸ã¸</button>
    <button id="logoutButtonSide">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<h1>ç®¡ç†è€…ç”¨ç”»é¢</h1>




<!-- h1ã®ã™ãä¸‹ã«è¿½åŠ ï¼šå¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ä½ç½® -->
<div style="text-align: right; margin-bottom: 10px;">
  <button id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>


<!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
<div style="margin-bottom: 20px;">
  <button class="tab-button active" onclick="switchTab('reservationsTab')">äºˆç´„æƒ…å ±ä¸€è¦§</button>
  <button class="tab-button" onclick="switchTab('emptyTab')">ç©ºå®¤è¡¨</button>
</div>

<!-- è¤‡æ•°é¸æŠãƒ»ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ -->
<div style="text-align: right; margin-bottom: 10px;">
  <button onclick="toggleMultiSelectMode()" id="multiSelectBtn">è¤‡æ•°é¸æŠ</button>
  <button onclick="cancelSelected()" id="cancelSelectedBtn" class="cancel-btn" style="display:none;">ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>


<!-- â–¼ ã“ã‚Œã‚’è¿½åŠ ï¼šäºˆç´„æƒ…å ±ä¸€è¦§ã‚¿ãƒ– -->
<div id="reservationsTab" class="tab-content">
  <div id="adminInfo"></div>

<!-- â–¼ æ˜‡é †ãƒ»é™é †ã®åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
<div style="text-align: right; margin-bottom: 10px;">
  <button onclick="changeSortOrder('asc')">æ˜‡é †</button>
  <button onclick="changeSortOrder('desc')">é™é †</button>
</div>

<table id="reservationsTable">
    <thead>
      <tr>
        <th>æ—¥ä»˜</th>
        <th>æ™‚é–“</th>
        <th>éƒ¨å±‹</th>
        <th>åå‰</th>
        <th>å­¦ç±ç•ªå·</th>
        <th>å­¦å¹´</th>
        <th>ãƒ¡ãƒ¼ãƒ«</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="emptyTab" class="tab-content" style="display:none;">
  <div style="text-align: center; margin-bottom: 10px;">
    <button id="prevDayBtn">ï¼œ å‰ã®æ—¥</button>
    <input type="text" id="datePicker" readonly style="width: 150px; text-align:center;">
    <button id="nextDayBtn">æ¬¡ã®æ—¥ ï¼</button>
  </div>
  <div id="scheduleTable"></div>
</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
  
function showLog(message) {
  const logArea = document.getElementById("debugLog");
  if (logArea) {
    const p = document.createElement("p");
    p.textContent = message;
    p.style.color = "red";
    p.style.fontSize = "14px";
    logArea.appendChild(p);
  }
}
    
    // Firebase åˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyCw6RzSw72t0BKoGjCONNPwz4plqn-74VY",
      authDomain: "yhasn-reserve.firebaseapp.com",
      projectId: "yhasn-reserve",
      storageBucket: "yhasn-reserve.appspot.com",
      messagingSenderId: "406712332925",
      appId: "1:406712332925:web:fb9253a313e4c76cfcb714"
    };
    // FirebaseåˆæœŸåŒ–
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// â–¼ ä¸¦ã¹æ›¿ãˆåˆ¶å¾¡ç”¨
let currentSortOrder = "asc";  // åˆæœŸã¯æ˜‡é †

function changeSortOrder(order) {
  currentSortOrder = order;
  loadReservations(); // ä¸¦ã¹æ›¿ãˆå†å®Ÿè¡Œ
}

// â–¼ è¿½è¨˜ï¼šè¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ç”¨
let multiSelectMode = false;
let selectedIds = [];



firebase.auth().onAuthStateChanged(user => {
  const redirectedFromLogout = sessionStorage.getItem("justLoggedOut");

  if (!user) {
    if (!redirectedFromLogout) {
      alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
    }
    window.location.href = "admin-login.html";
  } else {
    sessionStorage.removeItem("justLoggedOut"); // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãªã‚‰ä¸è¦
    document.getElementById("adminInfo").innerHTML = `
      <div style="color:#0277bd; font-weight:bold; font-size:15px;">
        ${user.email} ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­
      </div>
    `;
    loadReservations();
    setupFlatpickrAndButtons();
  }
});

function loadReservations() {
  console.log("âœ… loadReservations å®Ÿè¡Œã•ã‚ŒãŸã‚ˆï¼");
  showLog("âœ… loadReservations å®Ÿè¡Œã•ã‚ŒãŸï¼");  // â†ã“ã“è¿½åŠ 

  const tbody = document.querySelector("#reservationsTable tbody");
  tbody.innerHTML = "";

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;

  db.collection("reservations")
  .where("date", ">=", todayStr)
	.orderBy("date", currentSortOrder)
	.orderBy("time", currentSortOrder)
	.orderBy("room", "asc")
	.orderBy("studentId", "asc")
	.orderBy("name", "asc")
	.orderBy("grade", "asc")
	.orderBy("email", "asc")
    .get()
    .then(snapshot => {
      showLog("ğŸ“¦ äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...ä»¶æ•°: " + snapshot.size); // â†ã“ã“è¿½åŠ 

      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='8'>æœ¬æ—¥ä»¥é™ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        showLog("â–¶ï¸ " + JSON.stringify(data)); // â†ã“ã“è¿½åŠ 

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.date}</td>
          <td>${data.time}</td>
          <td>${data.room}</td>
          <td>${data.name}</td>
          <td>${data.studentId || ""}</td>
          <td>${data.grade || ""}</td>
          <td>${data.email}</td>
          <td>
            ${
              multiSelectMode
                ? `<input type="checkbox" class="multi-cancel-checkbox" data-id="${doc.id}" onchange="toggleSelect('${doc.id}', this.checked)">`
                : `<button class="cancel-btn" data-id="${doc.id}" onclick="cancelSingle('${doc.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("reservationsTable").classList.remove("multi-mode");
      document.getElementById("cancelSelectedBtn").style.display = "none";

      tbody.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          if (confirm("ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ")) {
            db.collection("reservations").doc(id).delete().then(() => {
              alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
              loadReservations();
            }).catch(err => {
              alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ");
              console.error(err);
            });
          }
        });
      });
            // â–¼ è¿½åŠ ï¼šè¤‡æ•°é¸æŠä¸­ãªã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³è¡¨ç¤º
      if (multiSelectMode) {
        document.getElementById("cancelSelectedBtn").style.display = "inline-block";
      } else {
        document.getElementById("cancelSelectedBtn").style.display = "none";
      }
    })
    .catch(err => {
      showLog("âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);  // â†ã“ã“è¿½åŠ 
      console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
      tbody.innerHTML = "<tr><td colspan='8'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>";
      document.body.innerHTML += `<p style="color:red;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
    });
}

   document.getElementById("logoutButton").addEventListener("click", () => {
  sessionStorage.setItem("justLoggedOut", "1"); // â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç›´å¾Œã®åˆ¤å®šç”¨
  firebase.auth().signOut().then(() => {
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ç”»é¢é·ç§»ã—ã¾ã™");
    location.href = "admin-login.html";
  });
});
    
function switchTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(div => div.style.display = "none");
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));

  document.getElementById(tabId).style.display = "block";
  
    // â–¼ è¿½åŠ ï¼šè¤‡æ•°é¸æŠãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  const multiBtn = document.getElementById("multiSelectBtn");
  const cancelBtn = document.getElementById("cancelSelectedBtn");
  if (multiBtn && cancelBtn) {
    if (tabId === "reservationsTab") {
      multiBtn.style.display = "inline-block";
      if (multiSelectMode) {
        cancelBtn.style.display = "inline-block";
      }
    } else {
      multiBtn.style.display = "none";
      cancelBtn.style.display = "none";
    }
  }

  // å‘¼ã³å‡ºã—å…ƒã‚¤ãƒ™ãƒ³ãƒˆãŒä½¿ãˆãªã„ã®ã§ã€classè¿½åŠ ã¯ tabId ã«å¿œã˜ã¦æ˜ç¤ºçš„ã«æ›¸ã
  if (tabId === "reservationsTab") {
    document.querySelector("button[onclick*='reservationsTab']").classList.add("active");
  } else if (tabId === "emptyTab") {
    document.querySelector("button[onclick*='emptyTab']").classList.add("active");
  }

  if (tabId === "emptyTab") {
    const fp = document.getElementById("datePicker")._flatpickr;
    const selected = fp.selectedDates[0] || fp.latestSelectedDateObj || fp.parseDate(fp.input.value);
    if (selected) {
      currentDate = selected;
      loadSchedule(currentDate);
      updatePrevButtonVisibility(currentDate);
    }
  }
}

// ç¥æ—¥ãƒªã‚¹ãƒˆ
const allHolidays = {
  "2025-01-01": "å…ƒæ—¥",
  "2025-01-13": "æˆäººã®æ—¥",
  "2025-02-11": "å»ºå›½è¨˜å¿µã®æ—¥",
  "2025-02-23": "å¤©çš‡èª•ç”Ÿæ—¥",
  "2025-03-20": "æ˜¥åˆ†ã®æ—¥",
  "2025-04-29": "æ˜­å’Œã®æ—¥",
  "2025-05-03": "æ†²æ³•è¨˜å¿µæ—¥",
  "2025-05-04": "ã¿ã©ã‚Šã®æ—¥",
  "2025-05-05": "ã“ã©ã‚‚ã®æ—¥",
  "2025-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
  "2025-07-21": "æµ·ã®æ—¥",
  "2025-08-11": "å±±ã®æ—¥",
  "2025-09-15": "æ•¬è€ã®æ—¥",
  "2025-09-23": "ç§‹åˆ†ã®æ—¥",
  "2025-10-13": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
  "2025-11-03": "æ–‡åŒ–ã®æ—¥",
  "2025-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
  "2025-12-23": "å¤©çš‡èª•ç”Ÿæ—¥"
};

let currentDate = getNextValidDate(new Date()); // â† ã‚°ãƒ­ãƒ¼ãƒãƒ«æ—¥ä»˜ç®¡ç†ç”¨

function getNextValidDate(date, step = 0) {
  const next = new Date(date);
  next.setDate(next.getDate() + step);
  while (next.getDay() === 0 || next.getDay() === 6 || allHolidays[formatDate(next)]) {
    next.setDate(next.getDate() + (step >= 0 ? 1 : -1));
  }
  return next;
}

function formatDate(date) {
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function loadSchedule(date) {
  const scheduleTable = document.getElementById("scheduleTable");
  scheduleTable.innerHTML = "";

  const dateStr = formatDate(date);
  const timeSlots = ["08:30-09:00", "09:00-10:40ï¼ˆï¼‘é™ï¼‰", "10:40-12:10ï¼ˆï¼’é™ï¼‰", "12:10-13:20ï¼ˆæ˜¼ä¼‘ã¿ï¼‰", "13:20-15:00ï¼ˆï¼“é™ï¼‰", "15:00-16:30ï¼ˆï¼”é™ï¼‰", "16:30-18:00", "18:00-20:00"];
  const allRooms = [
    "å­¦ç”Ÿæ¼”ç¿’å®¤1", "å­¦ç”Ÿæ¼”ç¿’å®¤2", "å­¦ç”Ÿæ¼”ç¿’å®¤3", "å­¦ç”Ÿæ¼”ç¿’å®¤4", "å­¦ç”Ÿæ¼”ç¿’å®¤5",
    "äº¤æµå®¤", "ãƒ™ãƒƒãƒ‰1", "ãƒ™ãƒƒãƒ‰2", "ãƒ™ãƒƒãƒ‰3", "ãƒ™ãƒƒãƒ‰4", "ãƒ™ãƒƒãƒ‰5", "ãƒ™ãƒƒãƒ‰6",
    "ãƒ™ãƒƒãƒ‰7", "ãƒ™ãƒƒãƒ‰8", "ãƒ™ãƒƒãƒ‰9", "ãƒ™ãƒƒãƒ‰10", "ãƒ™ãƒƒãƒ‰11", "ãƒ™ãƒƒãƒ‰12"
  ];

  db.collection("reservations")
    .where("date", "==", dateStr)
    .get()
    .then(snapshot => {
      const dataMap = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        dataMap[`${data.time}_${data.room}`] = data;
      });

      function generateTable(rooms, title) {
        let html = `<h3>${title}</h3><table><thead><tr><th>æ™‚é–“å¸¯</th>`;
        rooms.forEach(room => html += `<th>${room}</th>`);
        html += `</tr></thead><tbody>`;

        timeSlots.forEach(time => {
          html += `<tr><td class="time-label">${time}</td>`;
          rooms.forEach(room => {
            const key = `${time}_${room}`;
            const d = dataMap[key];
            if (d) {
             html += `<td>
  <div style="font-size: 12px; font-weight: bold;">${d.studentId || ""}</div>
  <div style="font-size: 13px;">${d.grade || ""}</div>
  <div style="font-size: 14px; font-weight: 600; color: #0277bd;">${d.name || ""}</div>
</td>`;
            } else {
           html += `<td class="empty" title="äºˆç´„å¯èƒ½"><i class="fas fa-circle"></i></td>`;
            }
          });
          html += `</tr>`;
        });

        html += `</tbody></table><br>`;
        return html;
      }

      const group1 = allRooms.filter(r => r.includes("æ¼”ç¿’å®¤") || r.includes("äº¤æµå®¤"));
      const group2 = allRooms.filter(r => r.includes("ãƒ™ãƒƒãƒ‰"));

      scheduleTable.innerHTML =
        generateTable(group1, "å­¦ç”Ÿæ¼”ç¿’å®¤ãƒ»äº¤æµå®¤") +
        generateTable(group2, "ãƒ™ãƒƒãƒ‰ï¼ˆ1ã€œ12ï¼‰");
    })
    .catch(err => {
      scheduleTable.innerHTML = `<p style="color:red;">èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}</p>`;
    });
}

function setupFlatpickrAndButtons() {
  flatpickr("#datePicker", {
  locale: "ja",
  dateFormat: "Y-m-d",
  defaultDate: currentDate,
minDate: new Date(), // â† åœŸæ—¥ç¥ã«é–¢ä¿‚ãªãã€Œä»Šæ—¥ã€ã‹ã‚‰é¸æŠå¯èƒ½
  disable: [
    function(date) {
      const day = date.getDay();
      const dateStr = formatDate(date);
      return day === 0 || day === 6 || allHolidays[dateStr];
    }
  ],
onChange: ([selectedDate]) => {
  if (selectedDate) {
    currentDate = selectedDate;
    loadSchedule(currentDate);
    updatePrevButtonVisibility(currentDate);
  }
},
 onReady: ([selectedDate]) => {
  currentDate = selectedDate || currentDate;
  loadSchedule(currentDate);
  updatePrevButtonVisibility(currentDate);
}
    
});
setTimeout(() => {
  const fp = document.getElementById("datePicker")._flatpickr;
  fp.setDate(currentDate, true);
fp.input.value = formatDate(currentDate); // â† ã“ã‚Œè¿½åŠ ï¼
}, 0);
document.getElementById("prevDayBtn").addEventListener("click", () => {
  const fp = document.getElementById("datePicker")._flatpickr;
  const newDate = getNextValidDate(currentDate, -1);
currentDate = newDate;
fp.setDate(newDate, true);
fp.input.value = formatDate(newDate); // â† ã“ã‚Œè¿½åŠ ï¼
loadSchedule(newDate);
updatePrevButtonVisibility(currentDate);
});

document.getElementById("nextDayBtn").addEventListener("click", () => {
  const fp = document.getElementById("datePicker")._flatpickr;
const newDate = getNextValidDate(currentDate, 1);
currentDate = newDate;
fp.setDate(newDate, true);
fp.input.value = formatDate(newDate); // â† ã“ã‚Œè¿½åŠ ï¼
loadSchedule(newDate);
updatePrevButtonVisibility(currentDate);
});


 
  function updatePrevButtonVisibility(selectedDate) {
  const today = new Date();
  today.setHours(0, 0, 0, 0); // æ™‚é–“éƒ¨åˆ†ã‚’ç„¡è¦–ã™ã‚‹ãŸã‚ã‚¯ãƒªã‚¢
  const selected = new Date(selectedDate);
  selected.setHours(0, 0, 0, 0);
  
  const isBeforeOrSame = selected <= today;
  document.getElementById("prevDayBtn").style.display = isBeforeOrSame ? "none" : "inline-block";
}
}
    // â–¼ ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
document.getElementById("cancelSelectedBtn").addEventListener("click", () => {
  const checkboxes = document.querySelectorAll(".multi-cancel-checkbox:checked");
  if (checkboxes.length === 0) {
    alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹äºˆç´„ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (!confirm(`${checkboxes.length}ä»¶ã®äºˆç´„ã‚’ä¸€æ‹¬ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  const idsToDelete = Array.from(checkboxes).map(cb => cb.dataset.id);
  let successCount = 0;
  let errorCount = 0;

  const promises = idsToDelete.map(id =>
    db.collection("reservations").doc(id).delete()
      .then(() => successCount++)
      .catch(() => errorCount++)
  );

  Promise.all(promises).then(() => {
    alert(`ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†ï¼š${successCount}ä»¶ã€å¤±æ•—ï¼š${errorCount}ä»¶`);
    loadReservations(); // å†èª­ã¿è¾¼ã¿
  });
});
function toggleSelect(id, checked) {
  if (checked) {
    selectedIds.push(id);
  } else {
    selectedIds = selectedIds.filter(i => i !== id);
  }
}

function toggleMultiSelectMode() {
  multiSelectMode = !multiSelectMode;
  document.getElementById("cancelSelectedBtn").style.display = multiSelectMode ? "inline-block" : "none";
  loadReservations(); // â† ã“ã‚Œã§è¡¨ç¤ºã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
}

// ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
document.getElementById("menuToggle").addEventListener("click", () => {
  const sideMenu = document.getElementById("sideMenu");
  sideMenu.classList.toggle("visible");
});

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
document.getElementById("logoutButtonSide").addEventListener("click", () => {
  sessionStorage.setItem("justLoggedOut", "1");
  firebase.auth().signOut().then(() => {
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ç”»é¢é·ç§»ã—ã¾ã™");
    location.href = "admin-login.html";
  });
});

// Firebaseãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤º
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    const emailDiv = document.getElementById("menuUserEmail");
    if (emailDiv) {
      emailDiv.textContent = `${user.email} ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;
    }
  }
});

  </script>
  <div id="debugLog" style="margin-top: 30px; padding: 10px; border: 2px dashed red;"></div>
</body>
</html>



