<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YHASNæ–½è¨­äºˆç´„(æ•™å“¡å°‚ç”¨)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f0f4f8;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 30px;
    }
    h1 {
      text-align: center;
      color: #1a237e;
    }
    .container {
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 30px;
      width: 100%;
      max-width: 900px;
      border: 2px solid #bbdefb;
    }
    label, p {
      font-size: 16px;
      color: #333;
    }
   table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #e1f5fe;
  border-radius: 8px;
  overflow: hidden;
}
    th {
      height:200px;
    }
    th, td {
      border: 1px solid #81d4fa;
      padding: 12px;
      text-align: center;
      height: 40px;
    }
    td.disabled {
      background-color: #b3e5fc;
      color: #999;
      cursor: not-allowed;
    }
   td.available {
  background-color: #ffffff;
  cursor: pointer;
  transition: background-color 0.3s;
}
td.available:not(.clickable) {
  cursor: not-allowed;
  /* opacity: 0.4; â† ã“ã‚Œã‚’å‰Šé™¤ */
}
td.available.selected {
  background-color: #aed581 !important;
}
    button {
      background-color: #1976d2;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      transition: background-color 0.3s;
    }
    button:hover {
  background-color: #125ca1;
    }
    #dateControls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #completeSection {
      text-align: center;
      margin-top: 30px;
    }
    #errorMsg {
      color: red;
      margin-top: 10px;
    }
    #loading {
      text-align: center;
      font-size: 24px;
      color: #0277bd;
      margin: 20px 0;
    }
 button.selectAllRowBtn.on {
  background-color: #d32f2f; /* èµ¤ç³»ï¼ˆå…¨è§£é™¤ï¼‰ */
  color: white;
}

td.available.reserved {
  background-color: #e0f7fa;
  font-weight: bold;
}

/* ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
#busyOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;            /* é€šå¸¸ã¯éè¡¨ç¤º */
  align-items: center;
  justify-content: center;
  z-index: 9999;            /* ç”»é¢æœ€ä¸Šä½ */
  backdrop-filter: blur(2px);
}

#busyOverlay.show {
  display: flex;
}

/* ãã‚‹ãã‚‹æœ¬ä½“ */
.busy-spinner {
  width: 64px;
  height: 64px;
  border: 6px solid rgba(255,255,255,0.35);
  border-top-color: #ffffff;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
  box-shadow: 0 0 10px rgba(0,0,0,0.2) inset;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.busy-message {
  margin-top: 14px;
  color: #fff;
  font-size: 14px;
  text-align: center;
}

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è–„ãè¦‹ã›ãŸã„æ™‚ã«ä»˜ã‘ã‚‹ã‚¯ãƒ©ã‚¹ */
.body-dimmed {
  filter: grayscale(10%) brightness(0.92);
}

/* å›è»¢ã‚¢ãƒ‹ãƒ¡ */
@keyframes spin {
  to { transform: rotate(360deg); }
}

  </style>
</head>

<body>

<!-- âœ… ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šï¼‰ -->
<div style="position: absolute; top: 20px; right: 30px; z-index: 999;">
  <button onclick="location.href='admin.html'" style="background-color: #388e3c; color: white; padding: 10px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">
    ç®¡ç†è€…ç”¨ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
  </button>
</div>

  <div class="container">
    
    <h1>YHASNæ–½è¨­äºˆç´„(æ•™å“¡å°‚ç”¨)
    </h1>

    <div id="dateControls">
      <button type="button" id="prevDayBtn">ï¼œ å‰ã®æ—¥</button>
      <label id="dateLabel">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„: <input type="text" id="date" required></label>
      <button type="button" id="nextDayBtn">æ¬¡ã®æ—¥ ï¼</button>
    </div>

    <div id="reserveForm">
  <div id="selectedDateDisplay" style="text-align:center; font-size:22px; font-weight:bold; margin:20px 0;"></div>
<h3>äº¤æµå®¤ãƒ»ãƒ™ãƒƒãƒ‰ï¼ˆ1ã€œ12ï¼‰</h3>
<div id="scheduleTableRooms"></div>

<div id="scheduleTableBeds" style="display:none;"></div> <!-- â† è¡¨ç¤ºã•ã‚Œãªã„ãƒ€ãƒŸãƒ¼ã§ã‚‚OK -->

      <div id="reservationSection" style="display:none; margin-top:20px;">
        <h2>äºˆç´„ç¢ºèª</h2>
        <p id="selectedInfo"></p>
       
        <label>åå‰: <input type="text" id="name" required></label><br><br>
        <button type="button" id="loginAndReserveButton">äºˆç´„ã™ã‚‹</button>
      </div>
    </div>

    <div style="text-align:center; margin-top:20px;">
  <button type="button" id="loginButton">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦äºˆç´„ã™ã‚‹</button>
  <button type="button" id="logoutButton" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  <p id="userEmail" style="margin-top:10px;"></p>
</div>

    <div id="completeSection" style="display:none;">
      <h2>äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h2>
      <button id="backButton">äºˆç´„ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
      <br><br>
      <button onclick="location.href='admin.html'"style="background-color: #388e3c; color: white; padding: 10px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">ç®¡ç†è€…ç”¨ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</button>
    </div>

    <div id="errorMsg"></div>
    <div id="loading" style="display:none;"><i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCw6RzSw72t0BKoGjCONNPwz4plqn-74VY",
    authDomain: "yhasn-reserve.firebaseapp.com",
    projectId: "yhasn-reserve",
    storageBucket: "yhasn-reserve.appspot.com",
    messagingSenderId: "406712332925",
    appId: "1:406712332925:web:fb9253a313e4c76cfcb714"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

// ==== ç¥æ—¥è‡ªå‹•å–å¾—ï¼ˆholidays-jpï¼‰ ====
// https://holidays-jp.github.io/api/v1/<year>/date.json ã‹ã‚‰å–å¾—

const HOLIDAY_API = (year) => `https://holidays-jp.github.io/api/v1/${year}/date.json`;
const holidayStore = { loaded: {} }; // { '2025-01-01': 'å…ƒæ—¥', ..., loaded: {2025:true} }

function ymd(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

async function loadHolidaysForRange(startDate, endDate) {
  const y1 = startDate.getFullYear();
  const y2 = endDate.getFullYear();
  const years = [];
  for (let y = y1; y <= y2; y++) {
    if (!holidayStore.loaded[y]) years.push(y);
  }
  if (years.length === 0) return;
  await Promise.all(years.map(async (y) => {
    try {
      const res = await fetch(HOLIDAY_API(y), { cache: "no-store" });
      if (!res.ok) throw new Error(`fetch ${y} failed`);
      const data = await res.json(); // { "YYYY-MM-DD": "åç§°", ... }
      Object.keys(data).forEach(k => { holidayStore[k] = data[k]; });
      holidayStore.loaded[y] = true;
    } catch (e) {
      console.warn("ç¥æ—¥ã®å–å¾—ã«å¤±æ•—:", y, e);
    }
  }));
}

// ç¥æ—¥åˆ¤å®š
function isHoliday(dateLike) {
  const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
  return !!holidayStore[ymd(d)];
}


// db ã®ç›´å¾Œã«è¿½åŠ 
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwBztqWNBpozNAL9S10_K44z4T5l8vIv7a7s3SyjI1W7zZhvdhLfaZVeLNVSBvcxIQ06A/exec';
const SHARED_SECRET = 'yhasn_2025jichikai_reservation_sending-email';

// â˜… ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã§ã¯ã€Œä¸Šæ›¸ãã§æ¶ˆãˆãŸå…ƒäºˆç´„è€…ã€ã«ã ã‘ã‚­ãƒ£ãƒ³ã‚»ãƒ«é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹
async function sendMailForOverwriteCancel({ to, dateText, studentName, studentId, grade, items }) {
  // items: [{room:"ãƒ™ãƒƒãƒ‰01", time:"09:00-10:40(1é™)"}, ...]
  const prettyRoom = r =>
    r.startsWith("ãƒ™ãƒƒãƒ‰")
      ? "ãƒ™ãƒƒãƒ‰" + r.replace("ãƒ™ãƒƒãƒ‰", "").replace(/^0+/, "")
      : r;

  const rows = items.map(i => `
    <tr>
      <td style="padding:4px 8px;">${i.time}</td>
      <td style="padding:4px 8px;">${prettyRoom(i.room)}</td>
    </tr>
  `).join("");

  const subject = `ã€é‡è¦ã€‘äºˆç´„ãŒç®¡ç†è€…ã«ã‚ˆã‚Šã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸï¼š${dateText}`;
  const html = `
    <div style="font-family:'Noto Sans JP',sans-serif; line-height:1.7;">
      <p>${studentName || 'åˆ©ç”¨è€…'} æ§˜</p>
      <p>ä»¥ä¸‹ã®ã”äºˆç´„ã¯ã€ç®¡ç†è€…æ“ä½œï¼ˆä¸Šæ›¸ãäºˆç´„ï¼‰ã«ã‚ˆã‚Šã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚</p>
      <table style="border-collapse:collapse; margin-bottom:8px;">
        <tr><td style="padding:4px 8px;">æ—¥ä»˜</td><td style="padding:4px 8px;">${dateText}</td></tr>
        <tr><td style="padding:4px 8px;">æ°å</td><td style="padding:4px 8px;">${studentName || '-'}</td></tr>
        <tr><td style="padding:4px 8px;">å­¦ç±ç•ªå·</td><td style="padding:4px 8px;">${studentId || '-'}</td></tr>
        <tr><td style="padding:4px 8px;">å­¦å¹´</td><td style="padding:4px 8px;">${grade || '-'}</td></tr>
      </table>
      <table border="1" cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
        <tr><th style="padding:4px 8px;">æ™‚é–“</th><th style="padding:4px 8px;">éƒ¨å±‹</th></tr>
        ${rows}
      </table>
      <p style="margin-top:12px;">â€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯é€ä¿¡å°‚ç”¨ã§ã™ã€‚</p>
    </div>
  `;

  try {
    await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆå›é¿
      body: JSON.stringify({
        secret: SHARED_SECRET,
        to,
        subject,
        html,
        origin: location.origin
      })
    });
  } catch (e) {
    console.warn('ã‚­ãƒ£ãƒ³ã‚»ãƒ«é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—', e);
  }
}



  let currentUser = null;

firebase.auth().onAuthStateChanged(user => {
  currentUser = user;
  const loginBtn = document.getElementById("loginButton");
  const logoutBtn = document.getElementById("logoutButton");
  const userEmail = document.getElementById("userEmail");
  const reserveSection = document.getElementById("reservationSection");

  // UIåˆ‡ã‚Šæ›¿ãˆ
  if (user) {
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    userEmail.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­: " + user.email;
    reserveSection.style.display = "block";
  } else {
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    userEmail.textContent = "";
    reserveSection.style.display = "none";
  }

  // ğŸ” çŠ¶æ…‹å¤‰åŒ–ã«å¿œã˜ã¦è¡¨ã‚’å†æç”»
  if (selectedDate) {
    loadSchedule(selectedDate);
  }
});

  

  // Firestoreä¿å­˜åã«åˆã‚ã›ã¦0åŸ‹ã‚ã§æŒã¤ï¼ˆè¡¨ç¤ºã¯formatRoomNameã§é0åŸ‹ã‚ã«ï¼‰
  const rooms = [
    "å­¦ç”Ÿæ¼”ç¿’å®¤1", "å­¦ç”Ÿæ¼”ç¿’å®¤2", "å­¦ç”Ÿæ¼”ç¿’å®¤3", "å­¦ç”Ÿæ¼”ç¿’å®¤4", "å­¦ç”Ÿæ¼”ç¿’å®¤5",
    "äº¤æµå®¤",
    "ãƒ™ãƒƒãƒ‰01", "ãƒ™ãƒƒãƒ‰02", "ãƒ™ãƒƒãƒ‰03", "ãƒ™ãƒƒãƒ‰04", "ãƒ™ãƒƒãƒ‰05", "ãƒ™ãƒƒãƒ‰06",
    "ãƒ™ãƒƒãƒ‰07", "ãƒ™ãƒƒãƒ‰08", "ãƒ™ãƒƒãƒ‰09", "ãƒ™ãƒƒãƒ‰10", "ãƒ™ãƒƒãƒ‰11", "ãƒ™ãƒƒãƒ‰12"
  ];

  // è¡¨ç¤ºç”¨ã«ã€Œãƒ™ãƒƒãƒ‰01 â†’ ãƒ™ãƒƒãƒ‰1ã€ã«ç›´ã™
  function formatRoomName(room) {
    if (room.startsWith("ãƒ™ãƒƒãƒ‰")) {
      const num = room.replace("ãƒ™ãƒƒãƒ‰", "").replace(/^0+/, "");
      return "ãƒ™ãƒƒãƒ‰" + num;
    }
    return room;
  }

   
  // ç½®ãæ›ãˆ
const times = [
  "08:30-09:00",
  "09:00-10:40(1é™)",
  "10:40-12:10(2é™)",
  "12:10-13:20(æ˜¼ä¼‘ã¿)",
  "13:20-15:00(3é™)",
  "15:00-16:30(4é™)",
  "16:30-18:00",
  "18:00-20:00"
];

  let selectedDate = "";
  let selectedRoom = "";
  let selectedTime = "";
  let datePicker;

  function formatDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function formatDisplayDate(dateStr) {
  const date = new Date(dateStr);
  const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
  const y = date.getFullYear();
  const m = date.getMonth() + 1;
  const d = date.getDate()
  const w = weekdays[date.getDay()];
  return `${y}å¹´${m}æœˆ${d}æ—¥ï¼ˆ${w}ï¼‰`;
}

  function getNextValidDate(date, step) {
    const newDate = new Date(date);
    while (true) {
      newDate.setDate(newDate.getDate() + step);
      const formatted = formatDate(newDate);
      if (newDate.getDay() !== 0 && newDate.getDay() !== 6 && !isHoliday(newDate)) {
  return formatted;
}

    }
  }

function loadSchedule(date) {
selectedDate = date;
document.getElementById("selectedDateDisplay").textContent = formatDisplayDate(date);
if (datePicker) {
datePicker.setDate(date);
}

// ã€Œå‰ã®æ—¥ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
const today = formatDate(new Date());
document.getElementById("prevDayBtn").style.display = (date === today) ? "none" : "inline-block";

// ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–ï¼†ãã‚‹ãã‚‹é–‹å§‹
const loading = document.getElementById("loading");
document.getElementById("scheduleTableRooms").innerHTML = "";
loading.style.display = "block";
setBusy(true, "äºˆç´„è¡¨ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦");

const roomTimeStatus = {};
const promises = [];

times.forEach(time => {
roomTimeStatus[time] = {};
rooms.forEach(room => {
roomTimeStatus[time][room] = null;

const query = db.collection("reservations")
.where("date", "==", date)
.where("time", "==", time)
.where("room", "==", room);

promises.push(
query.get()
.then(snapshot => {
if (!snapshot.empty) {
const data = snapshot.docs[0].data();
roomTimeStatus[time][room] = { name: data.name || "" };
} else {
roomTimeStatus[time][room] = null;
}
})
.catch(err => {
console.warn(`èª­ã¿è¾¼ã¿å¤±æ•—: ${time} - ${room}`, err);
roomTimeStatus[time][room] = null;
})
);
});
});

Promise.all(promises)
.then(() => {
renderSchedule(roomTimeStatus);
})
.catch(error => {
console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
document.getElementById("loading").innerHTML = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
})
.finally(() => {
loading.style.display = "none";
setBusy(false); // â† æœ€å¾Œã«ãã‚‹ãã‚‹çµ‚äº†
});
}

  function renderSchedule(status) {
  const scheduleTableRooms = document.getElementById("scheduleTableRooms");
scheduleTableRooms.innerHTML = "";

const roomGroup1 = rooms.filter(r => r === "äº¤æµå®¤" || r.includes("ãƒ™ãƒƒãƒ‰")); // äº¤æµå®¤ã¨ãƒ™ãƒƒãƒ‰ã ã‘

  function generateTable(roomsSubset) {
let html = "<table><thead><tr><th>æ™‚é–“å¸¯</th>";
roomsSubset.forEach(room => {
  html += `<th>${formatRoomName(room)}</th>`;
});
html += `<th>ãƒ™ãƒƒãƒ‰å…¨é¸æŠ</th>`;
html += "</tr></thead><tbody>";


    times.forEach(time => {
  html += `<tr><th>${time}</th>`;
  roomsSubset.forEach(room => {
  if (status[time]) {
    const cellData = status[time][room];

    if (cellData && cellData.name) {
      html += `<td class="available reserved" data-room="${room}" data-time="${time}" data-name="${cellData.name}">
        <span title="æ—¢ã«äºˆç´„ã‚ã‚Šï¼š${cellData.name}">${cellData.name}</span>
      </td>`;
    } else {
      html += `<td class="available" data-room="${room}" data-time="${time}"><i class="fas fa-circle"></i></td>`;
    }
  } else {
    html += `<td class="disabled">-</td>`;  // â†ã“ã“ãŒ status[time] ãŒ null ã®å ´åˆã®å‡¦ç†
  }
});

  // ğŸ‘‡ ä¸€æ‹¬é¸æŠãƒœã‚¿ãƒ³ï¼ˆå³ç«¯ï¼‰ã‚’è¿½åŠ 
html += `<td><button class="selectAllRowBtn" data-time="${time}" data-state="off">å…¨é¸æŠ</button></td>`;

  html += "</tr>";
});

    html += "</tbody></table>";
    return html;
  }

scheduleTableRooms.innerHTML = generateTable(roomGroup1);
// scheduleTableBeds.innerHTML = ""; â† ä»Šã¯ä½¿ã£ã¦ã„ãªã„ã®ã§å‰Šé™¤

  const user = firebase.auth().currentUser;
  document.querySelectorAll("td.available").forEach(cell => {
    cell.style.cursor = user ? "pointer" : "default";
  });
  // âœ… æ™‚é–“å¸¯ã”ã¨ã®ä¸€æ‹¬é¸æŠãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
document.querySelectorAll(".selectAllRowBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const targetTime = btn.dataset.time;
    const targetCells = document.querySelectorAll(`td.available[data-time="${targetTime}"][data-room^="ãƒ™ãƒƒãƒ‰"]`);

    const allSelected = Array.from(targetCells).every(cell => cell.classList.contains("selected"));

    targetCells.forEach(cell => {
      cell.classList.toggle("selected", !allSelected);
    });

    // ğŸ” ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ»ã‚¯ãƒ©ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’æ›´æ–°
    if (allSelected) {
      btn.textContent = "å…¨é¸æŠ";
      btn.dataset.state = "off";
      btn.classList.remove("on");
    } else {
      btn.textContent = "å…¨è§£é™¤";
      btn.dataset.state = "on";
      btn.classList.add("on");
    }

    const selectedCells = document.querySelectorAll("td.available.selected, td.available.reserved.selected");
    document.getElementById("reservationSection").style.display = selectedCells.length > 0 ? "block" : "none";

    const info = Array.from(selectedCells).map(c => `${c.dataset.time} - ${c.dataset.room}`);
    document.getElementById("selectedInfo").textContent = `é¸æŠæ¸ˆ: \n${info.join('\n')}`;
  });
});
  

  function handleSelection(cell) {
    selectedRoom = cell.dataset.room;
    selectedTime = cell.dataset.time;
    document.getElementById("selectedInfo").textContent = `ã€${formatDisplayDate(selectedDate)}ã€‘ ${selectedTime} - ${selectedRoom}`;
  }

// ğŸ” ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆã®ã‚ã¨ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
document.querySelectorAll("td.available, td.available.reserved").forEach(cell => {
  cell.classList.remove("clickable");
  cell.removeEventListener("click", cell._clickHandler);

  if (firebase.auth().currentUser) {
    cell.classList.add("clickable");
    cell._clickHandler = () => {
      cell.classList.toggle("selected");

      const selectedCells = document.querySelectorAll("td.available.selected, td.available.reserved.selected");
      if (selectedCells.length > 0) {
        document.getElementById("reservationSection").style.display = "block";
      } else {
        document.getElementById("reservationSection").style.display = "none";
      }

      const info = Array.from(selectedCells).map(c => {
  const room = c.dataset.room;
  const time = c.dataset.time;
  return `${time} - ${formatRoomName(room)}`;
});
document.getElementById("selectedInfo").textContent = `é¸æŠæ¸ˆ: \n${info.join('\n')}`;

    };
    cell.addEventListener("click", cell._clickHandler);
  } else {
    cell._clickHandler = null;
    cell.style.pointerEvents = "none";
  }
});
}

  document.addEventListener("DOMContentLoaded", () => {
    // ç¥æ—¥ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ
(async () => {
  const today = new Date();
  const end   = new Date(); end.setDate(end.getDate() + 30);
  await loadHolidaysForRange(today, end);

  datePicker = flatpickr("#date", {
  dateFormat: "Y-m-d",
  minDate: "today",
  // maxDate ã‚’å‰Šé™¤ã—ã¦ç„¡åˆ¶é™ã«ã™ã‚‹
  disable: [
    date => {
      const wd = date.getDay();
      return wd === 0 || wd === 6 || isHoliday(date);
    }
  ],
  locale: "ja",
  allowInput: false,
  onChange: (selectedDates) => {
    if (selectedDates.length > 0) {
      const date = ymd(selectedDates[0]);
      loadSchedule(date);
    }
  }
});


  // âœ… åˆæœŸè¡¨ç¤ºæ—¥ï¼ˆä»Šæ—¥ãŒåœŸæ—¥ç¥ãªã‚‰ç›´è¿‘ã®å¹³æ—¥ã«ã‚·ãƒ•ãƒˆï¼‰
  function findInitialReserveDate(startDate) {
    let d = new Date(startDate);
    while (d.getDay() === 0 || d.getDay() === 6 || isHoliday(d)) {
      d.setDate(d.getDate() + 1);
    }
    return ymd(d);
  }

  selectedDate = findInitialReserveDate(new Date());
  loadSchedule(selectedDate);
})();


       // âœ… åˆæœŸè¡¨ç¤ºæ—¥ã‚’æ±ºå®šï¼ˆä»Šæ—¥ãŒåœŸæ—¥ç¥ãªã‚‰ç›´è¿‘ã®å¹³æ—¥ã«ã‚·ãƒ•ãƒˆï¼‰
    function findInitialReserveDate(startDate) {
      let d = new Date(startDate);
      while (d.getDay() === 0 || d.getDay() === 6 || isHoliday(d)) {
  d.setDate(d.getDate() + 1);
}

      return formatDate(d);
    }

    selectedDate = findInitialReserveDate(new Date());
    loadSchedule(selectedDate);


    document.getElementById("prevDayBtn").addEventListener("click", () => {
      const date = new Date(selectedDate);
      const prev = getNextValidDate(date, -1);
      loadSchedule(prev);
    });

    document.getElementById("nextDayBtn").addEventListener("click", () => {
      const date = new Date(selectedDate);
      const next = getNextValidDate(date, 1);
      loadSchedule(next);
    });

   document.getElementById("backButton").addEventListener("click", () => {
  document.getElementById("completeSection").style.display = "none";
  document.getElementById("scheduleTableRooms").style.display = "block";
  document.getElementById("scheduleTableBeds").style.display = "block";
  document.getElementById("dateControls").style.display = "flex";
  loadSchedule(selectedDate);
});
  });

  document.getElementById("loginButton").addEventListener("click", () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider).then(result => {
    if (!result.user.email.endsWith("@yhasn.ed.jp")) {
      alert("å­¦æ ¡ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ@yhasn.ed.jpï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      firebase.auth().signOut();
    }
  });
});

document.getElementById("logoutButton").addEventListener("click", () => {
  firebase.auth().signOut().then(() => {
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
    if (selectedDate) loadSchedule(selectedDate); // ğŸ‘ˆ å¼·åˆ¶å†æç”»ã§UIãƒªã‚»ãƒƒãƒˆ
  });
});

document.getElementById("loginAndReserveButton").addEventListener("click", async function () {
  const name = document.getElementById("name").value.trim();
  const selectedCells = document.querySelectorAll("td.available.selected");

  if (!selectedDate || selectedCells.length === 0 || !name) {
    document.getElementById("errorMsg").textContent = "ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  const provider = new firebase.auth.GoogleAuthProvider();

  try {
    const result = await firebase.auth().signInWithPopup(provider);
    const user = result.user;

    if (!user.email.endsWith("@yhasn.ed.jp")) {
      alert("å­¦æ ¡ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ@yhasn.ed.jpï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      await firebase.auth().signOut();
      return;
    }

    const batch = db.batch();

    // â˜… ä¸Šæ›¸ãã§æ¶ˆã—ãŸäºˆç´„ã‚’ã€Œå…ƒäºˆç´„è€…ãƒ¡ãƒ¼ãƒ«ã”ã¨ã€ã«ã¾ã¨ã‚ã‚‹ãƒãƒƒãƒ—
    //  { "someone@yhasn.ed.jp": { studentName, studentId, grade, items:[{room, time}, ...] }, ... }
    const cancelMailMap = {};

    for (const cell of selectedCells) {
      const room = cell.dataset.room;
      const paddedRoom = room.toString().replace(/^ãƒ™ãƒƒãƒ‰(\d+)$/, (_, n) => "ãƒ™ãƒƒãƒ‰" + n.padStart(2, "0"));
      const time = cell.dataset.time;

      const query = await db.collection("reservations")
        .where("date", "==", selectedDate)
        .where("room", "==", paddedRoom)
        .where("time", "==", time)
        .get();

      if (!query.empty) {
        const confirmed = confirm(`ã€Œ${time} - ${room}ã€ã¯æ—¢ã«äºˆç´„ãŒã‚ã‚Šã¾ã™ã€‚\nä¸Šæ›¸ãï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«â†’å†äºˆç´„ï¼‰ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`);
        if (!confirmed) {
          document.getElementById("errorMsg").textContent = "ä¸€éƒ¨ã®äºˆç´„ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚";
          return;
        }

        // â˜… ã“ã“ã§å…ƒäºˆç´„è€…æƒ…å ±ã‚’åé›†ã—ã¦ã‹ã‚‰ delete
        query.forEach(doc => {
          const d = doc.data();
          const to = (d.email || "").trim();
          if (to) {
            if (!cancelMailMap[to]) {
              cancelMailMap[to] = {
                studentName: d.name || "",
                studentId: d.studentId || "",
                grade: d.grade || "",
                items: []
              };
            }
            cancelMailMap[to].items.push({ room: paddedRoom, time });
          }
          batch.delete(doc.ref);
        });
      }

      const newRef = db.collection("reservations").doc();
      const studentId = "-";
      const grade = "-";

      batch.set(newRef, {
        room: paddedRoom,
        date: selectedDate,
        time,
        name,
        studentId,
        grade,
        email: user.email,   // ç®¡ç†è€…(å…ˆç”Ÿ)ã®ãƒ¡ãƒ¼ãƒ«
        createdAt: new Date()
      });
    }

    await batch.commit();

    // â˜… ã€Œä¸Šæ›¸ãã§æ¶ˆãˆãŸå…ƒäºˆç´„è€…ã€å…¨å“¡ã¸ã‚­ãƒ£ãƒ³ã‚»ãƒ«é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
    for (const [to, payload] of Object.entries(cancelMailMap)) {
      await sendMailForOverwriteCancel({
        to,
        dateText: selectedDate,
        studentName: payload.studentName,
        studentId: payload.studentId,
        grade: payload.grade,
        items: payload.items
      });
    }

    // ç”»é¢æ›´æ–°ï¼ˆæ—¢å­˜ï¼‰
    document.getElementById("reservationSection").style.display = "none";
    document.getElementById("dateControls").style.display = "none";
    document.getElementById("completeSection").style.display = "block";
    loadSchedule(selectedDate);

  } catch (error) {
    console.error("äºˆç´„ã‚¨ãƒ©ãƒ¼:", error);
    document.getElementById("errorMsg").textContent = "äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚";
  }
});


// ===== å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®è¡¨ç¤º/éè¡¨ç¤º =====
function setBusy(isBusy, message = "å‡¦ç†ä¸­ã§ã™â€¦") {
  const overlay = document.getElementById("busyOverlay");
  const msg = document.getElementById("busyMessage");
  if (!overlay || !msg) return;

  msg.textContent = message || "å‡¦ç†ä¸­ã§ã™â€¦";

  if (isBusy) {
    overlay.classList.add("show");
    document.body.classList.add("body-dimmed");
    // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–ï¼ˆå¿µã®ãŸã‚ï¼‰
    document.body.style.pointerEvents = "none";
    overlay.style.pointerEvents = "auto";
  } else {
    overlay.classList.remove("show");
    document.body.classList.remove("body-dimmed");
    document.body.style.pointerEvents = "";
  }
}


</script>

<!-- å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå‡¦ç†ä¸­è¡¨ç¤ºï¼‰ -->
<div id="busyOverlay" aria-hidden="true">
  <div>
    <div class="busy-spinner" role="progressbar" aria-label="å‡¦ç†ä¸­"></div>
    <div class="busy-message" id="busyMessage">å‡¦ç†ä¸­ã§ã™â€¦</div>
  </div>
</div>

</body>
</html>
