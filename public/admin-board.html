<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ²ç¤ºæ¿ï¼ˆãŠçŸ¥ã‚‰ã›ç®¡ç†ï¼‰ | YHASNæ–½è¨­äºˆç´„</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: 'Noto Sans JP', sans-serif; margin: 0; background:#f3fbfb; }
  h1 { margin: 60px 0 10px; color:#0288d1; text-align:center; font-size:32px; }

  /* ---- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆadmin.htmlã¨åŒç­‰ã®è¦‹ãŸç›®ï¼‰ ---- */
  #hamburgerMenu { position: fixed; top: 10px; left: 10px; z-index: 999; }
  #menuToggle { background:#00bcd4; color:#fff; border:none; padding:10px 14px; font-size:24px; border-radius:4px; cursor:pointer; }
  #menuToggle:hover { background:#0097a7; }
  #sideMenu { position: fixed; top:0; left:-280px; width:240px; height:100%; background:#e1f5fe; padding:20px;
              box-shadow:2px 0 6px rgba(0,0,0,0.2); transition:left .3s ease; z-index:1500; }
  #sideMenu.visible { left:0; }
  #sideMenu .menu-header { font-weight:700; font-size:18px; color:#006064; margin-bottom:16px; }
  #sideMenu .menu-user { font-size:14px; color:#333; margin-bottom:16px; }
  #sideMenu button { display:block; width:100%; margin:10px 0; padding:10px; background:#0288d1; color:#fff;
                     border:none; border-radius:4px; text-align:left; cursor:pointer; }
  #sideMenu button:hover { background:#0277bd; }
  #profileImage { width:50px; height:50px; border-radius:50%; object-fit:cover; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,.3); }
  #menuOverlay { position:fixed; top:0; left:280px; width:calc(100vw - 280px); height:100vh; background:rgba(0,0,0,.3);
                 z-index:1000; opacity:0; pointer-events:none; transition:opacity .3s ease; }
  #menuOverlay.visible { opacity:1; pointer-events:auto; }
  #menuOverlay.hidden  { opacity:0; pointer-events:none; }

  /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’èµ¤ãï¼†é–“éš” */
  #logoutButtonSide { background:#f44336 !important; margin-top:20px; text-align:center; }
  #logoutButtonSide:hover { background:#d32f2f !important; }

  /* ---- ãƒšãƒ¼ã‚¸æœ¬ä½“ ---- */
  .container { max-width: 980px; margin: 0 auto; padding: 0 16px 24px; }
  .card { background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.1); padding:16px; }
  label { display:block; margin:10px 0 6px; font-weight:600; }
  input[type="text"], textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:16px; }
  .row { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
  .btn { border:none; border-radius:6px; padding:8px 12px; font-weight:700; cursor:pointer; }
  .btn-blue { background:#0288d1; color:#fff; }
  .btn-blue:hover { background:#0277bd; }
  .btn-green { background:#2e7d32; color:#fff; }
  .btn-orange { background:#ef6c00; color:#fff; }
  .btn-red { background:#f44336; color:#fff; }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { border-bottom:1px solid #eee; padding:8px; vertical-align:top; text-align:left; }
  .muted { color:#777; font-size:12px; }
</style>
</head>
<body>

<!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="hamburgerMenu">
  <button id="menuToggle">&#9776;</button>
  <div id="sideMenu">
    <div class="menu-header">YHASNæ–½è¨­äºˆç´„ç®¡ç†</div>
    <div class="menu-user">
      <img id="profileImage" src="" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" style="display:none;">
      <div id="menuUserEmail">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div>
    </div>
    <hr>
    <button onclick="location.href='admin.html'">ç®¡ç†ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
    <button onclick="window.open('admin-reserve.html','_self')">æ•™å“¡ç”¨äºˆç´„ãƒšãƒ¼ã‚¸ã¸</button>
    <button onclick="window.open('admin-suspend.html','_self')">åœæ­¢ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</button>
    <button id="logoutButtonSide">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>
<div id="menuOverlay" class="hidden"></div>

<h1>æ²ç¤ºæ¿ï¼ˆãŠçŸ¥ã‚‰ã›ç®¡ç†ï¼‰</h1>

<div class="container">

  <!-- æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ -->
  <div class="card" style="margin-bottom:16px;">
    <h2 style="margin:0 0 10px; color:#01579b;">æ–°è¦æŠ•ç¨¿</h2>
    <div>
      <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input type="text" id="noticeTitle" placeholder="ä¾‹ï¼šä»Šé€±ã®äºˆç´„ãƒ«ãƒ¼ãƒ«ã«ã¤ã„ã¦">
    </div>
    <div>
      <label>æœ¬æ–‡</label>
      <textarea id="noticeBody" rows="5" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›"></textarea>
    </div>
    <div class="row" style="margin-top:6px;">
      <label><input type="checkbox" id="noticePinned"> ä¸Šéƒ¨ã«å›ºå®šã™ã‚‹</label>
      <label><input type="checkbox" id="noticePublic" checked> å…¬é–‹ã™ã‚‹ï¼ˆå­¦ç”Ÿã«è¡¨ç¤ºï¼‰</label>
      <span id="noticeMsg" class="muted"></span>
    </div>
    <div style="text-align:right; margin-top:8px;">
      <button class="btn btn-blue" onclick="reloadNotices()">å†èª­ã¿è¾¼ã¿</button>
      <button class="btn btn-green" onclick="submitNotice()">æŠ•ç¨¿</button>
    </div>
  </div>

  <!-- ä¸€è¦§ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <h2 style="margin:0 0 10px; color:#01579b;">æŠ•ç¨¿ä¸€è¦§</h2>
    <table class="table">
      <thead>
        <tr>
          <th>å›ºå®š</th>
          <th>å…¬é–‹</th>
          <th>ã‚¿ã‚¤ãƒˆãƒ« / æœ¬æ–‡</th>
          <th>ä½œæˆæ—¥æ™‚</th>
          <th style="text-align:right;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="noticeList">
        <tr><td colspan="5" class="muted" style="padding:12px;">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Firebase SDKï¼ˆcompatã§admin.htmlã¨åŒç³»çµ±ï¼‰ -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  // Firebase åˆæœŸåŒ–ï¼ˆadmin.html ã¨åŒä¸€è¨­å®šï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyCw6RzSw72t0BKoGjCONNPwz4plqn-74VY",
    authDomain: "yhasn-reserve.firebaseapp.com",
    projectId: "yhasn-reserve",
    storageBucket: "yhasn-reserve.appspot.com",
    messagingSenderId: "406712332925",
    appId: "1:406712332925:web:fb9253a313e4c76cfcb714"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³ã¸ï¼‰
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
      location.href = "admin-login.html";
      return;
    }
    const emailDiv = document.getElementById("menuUserEmail");
    if (emailDiv) {
      const name = user.displayName || "";
      const parts = name.trim().split(" ");
      const reversed = parts.length === 2 ? `${parts[0]} ${parts[1]}` : name;
      emailDiv.textContent = `${reversed}ï¼ˆ${user.email}ï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;
    }
    if (user.photoURL) {
      const img = document.getElementById("profileImage");
      img.src = user.photoURL; img.style.display = "block";
    }
    reloadNotices();
  });

  // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
  document.getElementById("menuToggle").addEventListener("click", () => {
    const side = document.getElementById("sideMenu");
    const overlay = document.getElementById("menuOverlay");
    const vis = side.classList.toggle("visible");
    if (vis) { overlay.classList.remove("hidden"); overlay.classList.add("visible"); }
    else { overlay.classList.remove("visible"); overlay.classList.add("hidden"); }
  });
  document.getElementById("menuOverlay").addEventListener("click", () => {
    document.getElementById("sideMenu").classList.remove("visible");
    const overlay = document.getElementById("menuOverlay");
    overlay.classList.remove("visible"); overlay.classList.add("hidden");
  });
  document.getElementById("logoutButtonSide").addEventListener("click", () => {
    firebase.auth().signOut().then(() => {
      alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ç”»é¢é·ç§»ã—ã¾ã™");
      location.href = "admin-login.html";
    });
  });

  // æ²ç¤ºæ¿ãƒ­ã‚¸ãƒƒã‚¯
  function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  function submitNotice(){
    const title = document.getElementById('noticeTitle').value.trim();
    const body  = document.getElementById('noticeBody').value.trim();
    const pinned = document.getElementById('noticePinned').checked;
    const isPublic = document.getElementById('noticePublic').checked;
    const msg = document.getElementById('noticeMsg');
    if (!title){ msg.textContent = "ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"; return; }

    const u = firebase.auth().currentUser;
    const author = u ? (u.email || u.uid) : '-';

    db.collection('notices').add({
      title, body, pinned, public: isPublic, author,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
      msg.textContent = "æŠ•ç¨¿ã—ã¾ã—ãŸã€‚";
      document.getElementById('noticeTitle').value = '';
      document.getElementById('noticeBody').value = '';
      document.getElementById('noticePinned').checked = false;
      document.getElementById('noticePublic').checked = true;
      reloadNotices();
      setTimeout(()=>{ msg.textContent=''; }, 1800);
    }).catch((e)=>{
  console.error('[notices.add] error:', e);
  msg.style.color = '#c62828';
  msg.textContent = `æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š${e?.message || e}`;
});

  }

  function renderRow(id, d){
    const created = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
    const ts = created ? `${created.getFullYear()}-${String(created.getMonth()+1).padStart(2,'0')}-${String(created.getDate()).padStart(2,'0')} ${String(created.getHours()).padStart(2,'0')}:${String(created.getMinutes()).padStart(2,'0')}` : '-';
    return `
      <tr data-id="${id}">
        <td>${d.pinned ? 'ğŸ“Œ' : ''}</td>
        <td>${d.public ? 'å…¬é–‹' : 'éå…¬é–‹'}</td>
        <td>
          <div style="font-weight:700;">${escapeHtml(d.title||'')}</div>
          ${d.body ? `<div class="muted" style="white-space:pre-wrap; margin-top:4px;">${escapeHtml(d.body)}</div>` : ''}
        </td>
        <td>${ts}</td>
        <td style="text-align:right;">
          <button class="btn btn-orange" onclick="toggleNotice('${id}','pinned',${!d.pinned})">${d.pinned ? 'å›ºå®šè§£é™¤' : 'å›ºå®š'}</button>
          <button class="btn btn-green"  onclick="toggleNotice('${id}','public',${!d.public})">${d.public ? 'éå…¬é–‹ã«' : 'å…¬é–‹ã«'}</button>
          <button class="btn btn-red"    onclick="deleteNotice('${id}')">å‰Šé™¤</button>
        </td>
      </tr>`;
  }

  function reloadNotices(){
    const tbody = document.getElementById('noticeList');
    tbody.innerHTML = `<tr><td colspan="5" class="muted" style="padding:12px;">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>`;
    db.collection('notices').orderBy('pinned','desc').orderBy('createdAt','desc').limit(100).get()
      .then(snap=>{
        if (snap.empty){ tbody.innerHTML = `<tr><td colspan="5" class="muted" style="padding:12px;">æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`; return; }
        let html=''; snap.forEach(doc=>{ html += renderRow(doc.id, doc.data()); });
        tbody.innerHTML = html;
      })
      .catch(e=>{ tbody.innerHTML = `<tr><td colspan="5" class="muted" style="padding:12px;color:#c62828;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼š${e.message}</td></tr>`; });
  }
  function toggleNotice(id, field, value){
    db.collection('notices').doc(id).set({ [field]: value }, { merge:true }).then(reloadNotices);
  }
  function deleteNotice(id){
    if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    db.collection('notices').doc(id).delete().then(reloadNotices);
  }
</script>
</body>
</html>
