<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YHASNæ–½è¨­äºˆç´„!</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #e8f5e9;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 30px;
    }
    h1 {
      text-align: center;
      color: #43a047;
    }
    .container {
  display: block; /* ã‚‚ã—ãã¯ flex ã®ã¾ã¾ã§OKã ãŒ */
  width: 100%;
  max-width: 1400px;
  margin: auto;
}

#topButtons {
  position: absolute;
  top: 20px;
  right: 30px;
  z-index: 999;
}
#topButtons button {
	margin-left: 10px;
}

    label, p {
      font-size: 16px;
      color: #333;
    }
   table {
  width: 90%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #ffffff;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #a5d6a7;
}
    th {
      height:200px;
    }
    th, td {
      
      background-color: #a5d6a7;
      border: 1px solid #81c784;
      padding: 12px;
      text-align: center;
      height: 40px;
		}
      th:first-child,
      td:first-child{
        white-space: nowrap;
    }
    td.disabled {
      background-color: #c8e6c9;
      color: #999;
      cursor: not-allowed;
    }
   td.available {
  background-color: #ffffff !important;
  cursor: pointer;
  transition: background-color 0.3s;
}
td.available:not(.clickable) {
  cursor: not-allowed;
  /* opacity: 0.4; â† ã“ã‚Œã‚’å‰Šé™¤ */
}
td.available.selected {
  background-color: #d0f0c0 !important;
}
    button {
      background-color: #66bb6a;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #4caf50;
    }
    
    #topRightLinks {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
}
#topRightLinks a {
  display: inline-block;
  margin-right: 10px;
  padding: 10px 16px;
  background-color: #43a047;
  color: white;
  text-decoration: none;
  border-radius: 4px;
  font-size: 14px;
}
#topRightLinks a:hover {
  background-color: #2e7d32;
}
    
    #dateControls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
#completeSection {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 60vh; /* é«˜ã•ã§ä¸­å¤®å¯„ã› */
  text-align: center;
}

#completeSection h2 {
  font-size: 28px;
  margin-bottom: 10px;
  color: #2e7d32;
}

#completeInfo {
  font-size: 18px;
  margin-bottom: 20px;
  color: #333;
  font-weight: normal; /* å¤ªå­—ã‚’è§£é™¤ */
}
    #errorMsg {
      color: red;
      margin-top: 10px;
    }
    #loading {
      text-align: center;
      font-size: 24px;
      color: #4caf50;
      margin: 20px 0;
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.8);
  justify-content: center;
  align-items: center;
}

.modal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
  border: 2px solid white;
  animation: fadeInZoom 0.3s ease;
}

.modal:target {
  display: flex;
}

.image-section {
  margin-top: 60px;
  text-align: center;
  width: 100%;
}

.image-section img {
  width: 70%;
  max-width: 600px;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin: 20px auto;
  cursor: zoom-in;
  display: block;
}

@keyframes fadeInZoom {
  0% {
    opacity: 0;
    transform: scale(0.9);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}


/* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
#menuButton {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1100;
  cursor: pointer;
}



#sideMenu {
  position: fixed;
  top: 0;
  left: 0;
  width: 240px;
  height: 100vh;
  background-color: #4caf50;
  color: white;
  padding: 20px;
  box-shadow: 2px 0 8px rgba(0,0,0,0.2);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: 1101;
}
#sideMenu.visible {
  transform: translateX(0);
}
#sideMenu button {
  width: 100%;
  margin-bottom: 10px;
  background-color: white;
  color: #4caf50;
  border: none;
  padding: 10px;
  font-size: 14px;
  border-radius: 4px;
  cursor: pointer;
}
#sideMenu hr {
  border: 0;
  height: 1px;
  background-color: #66bb6a;
}

/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å³ã«ãšã‚‰ã—ã¦è¡¨ç¤º */
/* æ—¢å­˜ã® #menuOverlay ã«è¿½è¨˜ä¿®æ­£ */
#menuOverlay {
  position: fixed;
  top: 0;
  left: 240px;
  width: calc(100vw - 240px);
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.3);
  z-index: 1000;
  opacity: 0; /* â† åˆæœŸã¯é€æ˜ */
  pointer-events: none;
  transition: opacity 0.3s ease; /* â† ãƒ•ã‚§ãƒ¼ãƒ‰ç”¨ */
}

/* è¡¨ç¤ºæ™‚ã®ã‚¯ãƒ©ã‚¹ */
#menuOverlay.show {
  opacity: 1;
  pointer-events: auto;
}

#userPhoto {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  display: none;
  margin-bottom: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}


  </style>
</head>

<body>

<!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒœã‚¿ãƒ³ -->
<div id="menuButton">
  <i class="fas fa-bars fa-2x"></i>
</div>


<!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼‰ -->
<div id="menuOverlay" class="hidden"></div>

<!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœ¬ä½“ -->
<div id="sideMenu"> 
<div class="menu-user">
  <img id="userPhoto" src="" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; display: none; margin-bottom: 10px;">
  <div id="displayName" style="font-size: 16px;"></div>
  <div id="displayEmail" style="font-size: 12px;"></div>
</div>

  <hr style="margin: 12px 0;">
  <button onclick="location.href='cancel.html'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒšãƒ¼ã‚¸ã¸</button>

  <hr style="margin: 12px 0; margin-top: 40px;">
  <button id="sidelogoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>
  
      <div id="topRightLinks">
  <a href="cancel.html">äºˆç´„ä¸€è¦§ï¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
</div>
  <div class="container">
    <h1>YHASNæ–½è¨­äºˆç´„</h1>

  <button type="button" id="loginButton">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦äºˆç´„ã™ã‚‹</button>
  <button type="button" id="logoutButton" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <div id="dateControls">
      <button type="button" id="prevDayBtn">ï¼œ å‰ã®æ—¥</button>
      <label id="dateLabel">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„: <input type="text" id="date" required></label>
      <button type="button" id="nextDayBtn">æ¬¡ã®æ—¥ ï¼</button>
    </div>



    <form id="reserveForm">
  <div id="selectedDateDisplay" style="text-align:center; font-size:22px; font-weight:bold; margin:20px 0;"></div>

      <div id="loading" style="display:none;"><i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...</div>
  <h3>å­¦ç”Ÿæ¼”ç¿’å®¤ãƒ»äº¤æµå®¤</h3>
<div id="scheduleTableRooms"></div>

<h3>ãƒ™ãƒƒãƒ‰ï¼ˆ1ã€œ12ï¼‰</h3>
<div id="scheduleTableBeds"></div>

      <div id="reservationSection" style="display:none; margin-top:20px;">
        <h2>äºˆç´„ç¢ºèª</h2>
        <p id="selectedInfo"></p>
        <label>å­¦ç±ç•ªå·: <input type="text" id="studentId" required></label><br><br>
        <label>å­¦å¹´:
          <select id="grade" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="1å¹´">1å¹´</option>
            <option value="2å¹´">2å¹´</option>
            <option value="3å¹´">3å¹´</option>
          </select>
        </label><br><br>
        <label>åå‰: <input type="text" id="name" required></label><br><br>
        <button type="button" id="loginAndReserveButton">äºˆç´„ã™ã‚‹</button>
      </div>
      <div id="errorMsg"></div>
    </form>

    <div style="text-align:center; margin-top:20px;">
      
      <!-- â–¼ æ•™å®¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”»åƒè¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œï¼‰ -->
<div class="image-section">
  <h2>æ¼”ç¿’å®¤ãƒ»äº¤æµå®¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h2>
  <p style="font-size: 14px; color: #555;">â€»ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§</p>

<img src="ensyuusitu2.jpg" alt="æ¼”ç¿’å®¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ" onclick="openModal('modalEnsyuu')">
  

  <h2>åŸºç¤çœ‹è­·å®Ÿç¿’å®¤ï¼ˆãƒ™ãƒƒãƒ‰1ã€œ12ï¼‰</h2>
  <p style="font-size: 14px; color: #555;">â€»ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§</p>
    <img src="bed2.jpg" alt="ãƒ™ãƒƒãƒ‰é…ç½®å›³" onclick="openModal('modalBed')">
  
</div>
      
  

  <p id="userEmail" style="margin-top:10px;"></p>
</div>

<div id="completeSection" style="display:none; text-align:center; margin-top: 40px;">
  <h2>äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h2>
  <button id="backButton">äºˆç´„ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
</div>

    

  </div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ -->
<div id="modalEnsyuu" class="modal" onclick="closeModal(event, 'modalEnsyuu')">
  <img src="ensyuusitu2.jpg" alt="æ¼”ç¿’å®¤æ‹¡å¤§">
</div>

<div id="modalBed" class="modal" onclick="closeModal(event,'modalBed')">
  <img src="bed2.jpg" alt="ãƒ™ãƒƒãƒ‰é…ç½®æ‹¡å¤§">
</div>  <!-- â–² æ•™å®¤ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”»åƒè¡¨ç¤ºã“ã“ã¾ã§ -->



  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCw6RzSw72t0BKoGjCONNPwz4plqn-74VY",
    authDomain: "yhasn-reserve.firebaseapp.com",
    projectId: "yhasn-reserve",
    storageBucket: "yhasn-reserve.appspot.com",
    messagingSenderId: "406712332925",
    appId: "1:406712332925:web:fb9253a313e4c76cfcb714"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUser = null;

firebase.auth().onAuthStateChanged(user => {
  currentUser = user;
  const loginBtn = document.getElementById("loginButton");
  const logoutBtn = document.getElementById("logoutButton");
  const userEmail = document.getElementById("userEmail");

if (user) {
  const fullName = user.displayName || "";
  const email = user.email || "";

  
  const displayNameElem = document.getElementById("displayName");
  const emailElem = document.getElementById("displayEmail");
  const photoElem = document.getElementById("userPhoto");

  if (displayNameElem) displayNameElem.textContent = fullName;
  if (emailElem) emailElem.textContent = email;
  if (photoElem && user.photoURL) {
    photoElem.src = user.photoURL;
    photoElem.style.display = "block";
  }
 

  const studentIdFromEmail = email.split("@")[0]; // 231103

  let combinedName = fullName;

  // ã€Œå§“ åã€ã®åŒºåˆ‡ã‚ŠãŒã‚¹ãƒšãƒ¼ã‚¹ã‚ã‚Šã®å ´åˆï¼ˆä¾‹: "B231103é˜¿éƒ¨ æ™ºä¹‹ä¸"ï¼‰
  if (fullName.includes(" ")) {
    const parts = fullName.split(" ");
    const familyPart = parts[0]; // B231103é˜¿éƒ¨
    const firstName = parts[1];  // æ™ºä¹‹ä¸

    const nameWithoutStudentId = familyPart.replace(/[AB]\d{6}/, ""); // é˜¿éƒ¨

    combinedName = `${nameWithoutStudentId} ${firstName}`;
  }

  // å…¥åŠ›æ¬„ã«è‡ªå‹•å…¥åŠ›
  const studentIdInput = document.getElementById("studentId");
  const nameInput = document.getElementById("name");

  if (studentIdInput && nameInput) {
    studentIdInput.value = studentIdFromEmail;
    nameInput.value = combinedName;
  }
}
  const reserveSection = document.getElementById("reservationSection");

  // UIåˆ‡ã‚Šæ›¿ãˆ
  if (user) {
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    userEmail.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­: " + user.email;
    reserveSection.style.display = "block";
  } else {
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    userEmail.textContent = "";
    reserveSection.style.display = "none";
  }

  // ğŸ” çŠ¶æ…‹å¤‰åŒ–ã«å¿œã˜ã¦è¡¨ã‚’å†æç”»
  if (selectedDate) {
    loadSchedule(selectedDate);
  }
});

  const holidays = {
    "2025-01-01": true, "2025-01-13": true, "2025-02-11": true, "2025-03-20": true,
    "2025-04-29": true, "2025-05-03": true, "2025-05-04": true, "2025-05-05": true,
    "2025-07-21": true, "2025-08-11": true, "2025-09-15": true, "2025-09-23": true,
    "2025-10-13": true, "2025-11-03": true, "2025-11-23": true, "2025-12-23": true
  };

  function addSubstituteHolidays(holidays) {
    const holidayDates = Object.keys(holidays).sort();
    const substituteHolidays = {};

    holidayDates.forEach(dateStr => {
      const date = new Date(dateStr);
      if (date.getDay() === 0) {
        let offset = 1;
        while (true) {
          const substitute = new Date(date);
          substitute.setDate(date.getDate() + offset);
          const y = substitute.getFullYear();
          const m = String(substitute.getMonth() + 1).padStart(2, "0");
          const d = String(substitute.getDate()).padStart(2, "0");
          const formatted = `${y}-${m}-${d}`;
          if (!holidays[formatted] && !substituteHolidays[formatted]) {
            substituteHolidays[formatted] = true;
            break;
          }
          offset++;
        }
      }
    });

    return { ...holidays, ...substituteHolidays };
  }

  const allHolidays = addSubstituteHolidays(holidays);

  const rooms = [
    "å­¦ç”Ÿæ¼”ç¿’å®¤1", "å­¦ç”Ÿæ¼”ç¿’å®¤2", "å­¦ç”Ÿæ¼”ç¿’å®¤3", "å­¦ç”Ÿæ¼”ç¿’å®¤4", "å­¦ç”Ÿæ¼”ç¿’å®¤5",
    "äº¤æµå®¤", "ãƒ™ãƒƒãƒ‰1", "ãƒ™ãƒƒãƒ‰2", "ãƒ™ãƒƒãƒ‰3", "ãƒ™ãƒƒãƒ‰4", "ãƒ™ãƒƒãƒ‰5", "ãƒ™ãƒƒãƒ‰6",
    "ãƒ™ãƒƒãƒ‰7", "ãƒ™ãƒƒãƒ‰8", "ãƒ™ãƒƒãƒ‰9", "ãƒ™ãƒƒãƒ‰10", "ãƒ™ãƒƒãƒ‰11", "ãƒ™ãƒƒãƒ‰12"
  ];
   
  const times = [
  { label: "08:30-09:00", value: "08:30-09:00" },
  { label: "09:00-10:40<br>ï¼ˆï¼‘é™ï¼‰", value: "09:00-10:40(1é™)" },
  { label: "10:40-12:10<br>ï¼ˆï¼’é™ï¼‰", value: "10:40-12:10(2é™)" },
  { label: "12:10-13:20<br>ï¼ˆæ˜¼ä¼‘ã¿ï¼‰", value: "12:10-13:20(æ˜¼ä¼‘ã¿)" },
  { label: "13:20-15:00<br>ï¼ˆï¼“é™ï¼‰", value: "13:20-15:00(3é™)" },
  { label: "15:00-16:30<br>ï¼ˆï¼”é™ï¼‰", value: "15:00-16:30(4é™)" },
  { label: "16:30-18:00", value: "16:30-18:00" },
  { label: "18:00-20:00", value: "18:00-20:00" }
];

  let selectedDate = "";
  let selectedRoom = "";
  let selectedTime = "";
  let datePicker;

  function formatDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function formatDisplayDate(dateStr) {
  const date = new Date(dateStr);
  const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
  const y = date.getFullYear();
  const m = date.getMonth() + 1;
  const d = date.getDate()
  const w = weekdays[date.getDay()];
  return `${y}å¹´${m}æœˆ${d}æ—¥ï¼ˆ${w}ï¼‰`;
}

function getNextValidDate(date, step) {
  const newDate = new Date(date);
  const maxDate = new Date(); // ä»Šæ—¥
  maxDate.setDate(maxDate.getDate() + 30); // 1ãƒ¶æœˆå¾Œ

  while (true) {
    newDate.setDate(newDate.getDate() + step);
    const formatted = formatDate(newDate);

    // âœ… ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆstep > 0ã®ã¨ãï¼‰
    if (step > 0 && newDate > maxDate) return formatDate(maxDate);

    // âœ… ä¸‹é™ãƒã‚§ãƒƒã‚¯ï¼ˆstep < 0ã®ã¨ãï¼‰
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (step < 0 && newDate < today) return formatDate(today);

    if (newDate.getDay() !== 0 && newDate.getDay() !== 6 && !allHolidays[formatted]) {
      return formatted;
    }
  }
}

  function loadSchedule(date) {
  selectedDate = date;
  document.getElementById("selectedDateDisplay").textContent = formatDisplayDate(date);
  if (datePicker) {
    datePicker.setDate(date);
  }

    // ã€Œå‰ã®æ—¥ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    const today = formatDate(new Date());
    document.getElementById("prevDayBtn").style.display = (date === today) ? "none" : "inline-block";

   const loading = document.getElementById("loading");
document.getElementById("scheduleTableRooms").innerHTML = "";
document.getElementById("scheduleTableBeds").innerHTML = "";
    loading.style.display = "block";

    const roomTimeStatus = {};
    const promises = [];

    times.forEach(time => {
  const timeVal = time.value;  // â† ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ
  roomTimeStatus[timeVal] = {};  // â† ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªãæ–‡å­—åˆ—ã‚­ãƒ¼ã‚’ä½¿ç”¨

  rooms.forEach(room => {
    roomTimeStatus[timeVal][room] = null;

    const query = db.collection("reservations")
      .where("date", "==", date)
      .where("time", "==", timeVal)  // â† ã“ã“ã‚‚ time.value ã‚’ä½¿ã†ã¹ã
      .where("room", "==", room);

    promises.push(query.get().then(snapshot => {
      if (!snapshot.empty) {
        const data = snapshot.docs[0].data();
        roomTimeStatus[timeVal][room] = {
          name: data.name || ""
        };
      }
    }));
  });
});

    Promise.all(promises).then(() => {
      renderSchedule(roomTimeStatus);
      loading.style.display = "none";
    });
  }

  function renderSchedule(status) {
  const scheduleTableRooms = document.getElementById("scheduleTableRooms");
  const scheduleTableBeds = document.getElementById("scheduleTableBeds");
  scheduleTableRooms.innerHTML = "";
  scheduleTableBeds.innerHTML = "";

  const roomGroup1 = rooms.filter(r => r.includes("æ¼”ç¿’å®¤") || r.includes("äº¤æµå®¤"));
  const roomGroup2 = rooms.filter(r => r.includes("ãƒ™ãƒƒãƒ‰"));

  function generateTable(roomsSubset) {
    let html = "<table><thead><tr><th>æ™‚é–“å¸¯</th>";
    roomsSubset.forEach(room => {
      html += `<th>${room}</th>`;
    });
    html += "</tr></thead><tbody>";

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç”Ÿæˆéƒ¨åˆ†
times.forEach(timeObj => {
  html += `<tr><th>${timeObj.label}</th>`;
  roomsSubset.forEach(room => {
    const timeVal = timeObj.value;
    if (status[timeVal][room]) {
      const info = status[timeVal][room];
      html += `<td class="disabled">${info.name || '<i class="fas fa-times"></i>'}</td>`;
    } else {
      html += `<td class="available" data-room="${room}" data-time="${timeVal}"><i class="fas fa-circle"></i></td>`;
    }
  });
  html += "</tr>";
});

    html += "</tbody></table>";
    return html;
  }

  scheduleTableRooms.innerHTML = generateTable(roomGroup1);
  scheduleTableBeds.innerHTML = generateTable(roomGroup2);

  const user = firebase.auth().currentUser;
  document.querySelectorAll("td.available").forEach(cell => {
    cell.style.cursor = user ? "pointer" : "default";
  });

  function handleSelection(cell) {
  selectedRoom = cell.dataset.room;
  selectedTime = cell.dataset.time;
  document.getElementById("selectedInfo").textContent = `ã€${formatDisplayDate(selectedDate)}ã€‘ ${selectedTime} - ${selectedRoom}`;
}

  document.querySelectorAll("td.available").forEach(cell => {
    cell.classList.remove("clickable");
    cell.removeEventListener("click", cell._clickHandler);

    if (firebase.auth().currentUser) {
      cell.classList.add("clickable");
      cell._clickHandler = () => {
        document.querySelectorAll("td.available.selected").forEach(c => c.classList.remove("selected"));
        cell.classList.add("selected");
        handleSelection(cell);
        document.getElementById("reservationSection").style.display = "block";
      };
      cell.addEventListener("click", cell._clickHandler);
    } else {
      cell._clickHandler = null;
      cell.style.pointerEvents = "none";
    }
  });
}

  document.addEventListener("DOMContentLoaded", () => {
datePicker = flatpickr("#date", {
  dateFormat: "Y-m-d",
  minDate: "today",
  maxDate: new Date().fp_incr(30),  // â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆ
      disable: [
        date => {
          const formatted = formatDate(date);
          return date.getDay() === 0 || date.getDay() === 6 || allHolidays[formatted];
        }
      ],
      locale: "ja",
      allowInput: false,
      onChange: (selectedDates) => {
        if (selectedDates.length > 0) {
          const date = formatDate(selectedDates[0]);
          loadSchedule(date);
        }
      }
    });

    const today = formatDate(new Date());
    selectedDate = getNextValidDate(new Date(), 0);
    loadSchedule(selectedDate);

    document.getElementById("prevDayBtn").addEventListener("click", () => {
      const date = new Date(selectedDate);
      const prev = getNextValidDate(date, -1);
      loadSchedule(prev);
    });

    document.getElementById("nextDayBtn").addEventListener("click", () => {
      const date = new Date(selectedDate);
      const next = getNextValidDate(date, 1);
      loadSchedule(next);
    });

   document.getElementById("backButton").addEventListener("click", () => {
document.getElementById("completeSection").style.display = "none";
document.getElementById("scheduleTableRooms").style.display = "block";
document.getElementById("scheduleTableBeds").style.display = "block";
document.getElementById("dateControls").style.display = "flex";

// ğŸ¯äºˆç´„è¡¨è¦‹å‡ºã—ã¨ç”»åƒã‚‚å¾©æ´»
document.querySelector(".image-section").style.display = "block";
document.querySelector("h3").style.display = "block";
document.querySelectorAll("h3")[1].style.display = "block";

loadSchedule(selectedDate);
});
  });

  document.getElementById("loginButton").addEventListener("click", () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider).then(result => {
    if (!result.user.email.endsWith("@yhasn.ed.jp")) {
      alert("å­¦æ ¡ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ@yhasn.ed.jpï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      firebase.auth().signOut();
    }
  });
});

document.getElementById("logoutButton").addEventListener("click", () => {
firebase.auth().signOut().then(() => {
  alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
  document.getElementById("errorMsg").textContent = ""; // ã‚¨ãƒ©ãƒ¼æ¶ˆå»
  if (selectedDate) loadSchedule(selectedDate);
  });
});

document.getElementById("sidelogoutButton").addEventListener("click", () => {
  firebase.auth().signOut().then(() => {
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
    document.getElementById("errorMsg").textContent = "";
    if (selectedDate) loadSchedule(selectedDate);
  });
});


  document.getElementById("loginAndReserveButton").addEventListener("click", function () {
  document.getElementById("errorMsg").textContent = ""; // â† ã“ã“ã‚’è¿½åŠ 

  const name = document.getElementById("name").value.trim();
  const studentId = document.getElementById("studentId").value.trim();
  const grade = document.getElementById("grade").value;

  if (!selectedDate || !selectedRoom || !selectedTime || !name || !studentId || !grade) {
    document.getElementById("errorMsg").textContent = "ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  // ğŸ” ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¿½åŠ 
  const confirmMsg = `ä»¥ä¸‹ã®å†…å®¹ã§äºˆç´„ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
    `æ—¥ä»˜ï¼š${formatDisplayDate(selectedDate)}\n` +
    `æ™‚é–“å¸¯ï¼š${selectedTime}\n` +
    `éƒ¨å±‹ï¼š${selectedRoom}\n` +
    `å­¦ç±ç•ªå·ï¼š${studentId}\n` +
    `å­¦å¹´ï¼š${grade}\n` +
    `åå‰ï¼š${name}`;

  if (!confirm(confirmMsg)) {
    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã‚‰ä½•ã‚‚ã—ãªã„
  }
  const user = firebase.auth().currentUser;

  if (!user) {
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (!user.email.endsWith("@yhasn.ed.jp")) {
    alert("å­¦æ ¡ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ@yhasn.ed.jpï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const emailStudentId = user.email.split("@")[0].slice(0, 6);
  if (emailStudentId !== studentId) {
    alert("ä¸æ­£ãªå­¦ç±ç•ªå·ã§ã™ã€‚\næ­£ã—ã„å­¦ç±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  // ğŸ” åŒæ—¥ãƒ»åŒå­¦ç±ç•ªå·ã®äºˆç´„ãŒæ—¢ã«ã‚ã‚‹ã‹ç¢ºèª
  db.collection("reservations")
    .where("date", "==", selectedDate)
    .where("studentId", "==", studentId)
    .get()
    .then(snapshot => {
      if (!snapshot.empty) {
        alert("æ—¢ã«ã“ã®æ—¥ã«ã¯äºˆç´„ãŒã‚ã‚Šã¾ã™ã€‚\n1æ—¥ã«è¤‡æ•°ã®äºˆç´„ã¯ã§ãã¾ã›ã‚“ã€‚");
        return;
      }

      // âœ… é‡è¤‡ãŒãªã‘ã‚Œã°äºˆç´„ã‚’è¿½åŠ 
            let roomToSave = selectedRoom;
      if (roomToSave.startsWith("ãƒ™ãƒƒãƒ‰")) {
        const bedNum = roomToSave.replace("ãƒ™ãƒƒãƒ‰", "");
        const padded = bedNum.padStart(2, "0");
        roomToSave = `ãƒ™ãƒƒãƒ‰${padded}`;
      }

      db.collection("reservations").add({
        room: roomToSave,
        date: selectedDate,
        time: selectedTime,
        name,
        studentId,
        grade,
        email: user.email,
        createdAt: new Date()
      }).then(() => {
// äºˆç´„æˆåŠŸå¾Œã®ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("reservationSection").style.display = "none";
document.getElementById("dateControls").style.display = "none";
document.getElementById("scheduleTableRooms").style.display = "none";
document.getElementById("scheduleTableBeds").style.display = "none";

// ğŸ¯ç”»åƒã¨è¦‹å‡ºã—ã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆå®Œäº†ç”»é¢ç”¨ï¼‰
document.querySelector(".image-section").style.display = "none";
document.querySelector("h3").style.display = "none"; // æ¼”ç¿’å®¤ãƒ»äº¤æµå®¤è¦‹å‡ºã—
document.querySelectorAll("h3")[1].style.display = "none"; // ãƒ™ãƒƒãƒ‰è¦‹å‡ºã—


// å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
document.getElementById("completeSection").style.display = "block";

// ğŸ” ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
document.getElementById("errorMsg").textContent = "";
 }).catch(error => {
        console.error("äºˆç´„ã‚¨ãƒ©ãƒ¼:", error);
        document.getElementById("errorMsg").textContent = "äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚";
      });
    });
});

function openModal(id) {
  document.getElementById(id).style.display = "flex";
}

function closeModal(event, id) {
  // ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã¯é–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹
  if (event.target.tagName.toLowerCase() === 'img') return;
  document.getElementById(id).style.display = "none";
}

// ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰å‡¦ç†
document.addEventListener("DOMContentLoaded", () => {
  const menuBtn = document.getElementById("menuButton");
  const sideMenu = document.getElementById("sideMenu");
  const menuOverlay = document.getElementById("menuOverlay");

  menuBtn.addEventListener("click", () => {
    sideMenu.classList.add("visible");
    menuOverlay.classList.add("show"); // â† ä¿®æ­£
  });

  menuOverlay.addEventListener("click", () => {
    sideMenu.classList.remove("visible");
    menuOverlay.classList.remove("show"); // â† ä¿®æ­£
  });
});



</script>





</body>
</html>

